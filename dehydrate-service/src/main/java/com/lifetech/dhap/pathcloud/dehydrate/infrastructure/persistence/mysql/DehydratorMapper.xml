<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lifetech.dhap.pathcloud.dehydrate.domain.DehydratorRepository">
    <resultMap id="BaseResultMap" type="com.lifetech.dhap.pathcloud.dehydrate.domain.model.Dehydrator">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Tue Dec 13 16:37:30 CST 2016.
        -->
        <id column="id" jdbcType="BIGINT" property="id"/>
        <result column="instrument_id" jdbcType="BIGINT" property="instrumentId"/>
        <result column="status" jdbcType="INTEGER" property="status"/>
        <result column="used_block" jdbcType="INTEGER" property="usedBlock"/>
        <result column="capacity" jdbcType="INTEGER" property="capacity"/>
        <result column="reset_time" jdbcType="TIMESTAMP" property="resetTime"/>
        <result column="start_time" jdbcType="TIMESTAMP" property="startTime"/>
        <result column="end_time" jdbcType="TIMESTAMP" property="endTime"/>
        <result column="create_by" jdbcType="BIGINT" property="createBy"/>
        <result column="update_by" jdbcType="BIGINT" property="updateBy"/>
        <result column="create_time" jdbcType="TIMESTAMP" property="createTime"/>
        <result column="update_time" jdbcType="TIMESTAMP" property="updateTime"/>
    </resultMap>
    <delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Tue Dec 13 16:37:30 CST 2016.
        -->
        delete from dehydrator
        where id = #{id,jdbcType=BIGINT}
    </delete>
    <insert id="insert" parameterType="com.lifetech.dhap.pathcloud.dehydrate.domain.model.Dehydrator">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Tue Dec 13 16:37:30 CST 2016.
        -->
        insert into dehydrator (id, instrument_id, status,
        used_block, capacity, reset_time,
        start_time, end_time, create_by,
        update_by, create_time, update_time
        )
        values (#{id,jdbcType=BIGINT}, #{instrumentId,jdbcType=BIGINT}, #{status,jdbcType=INTEGER},
        #{usedBlock,jdbcType=INTEGER}, #{capacity,jdbcType=INTEGER}, #{resetTime,jdbcType=TIMESTAMP},
        #{startTime,jdbcType=TIMESTAMP}, #{endTime,jdbcType=TIMESTAMP}, #{createBy,jdbcType=BIGINT},
        #{updateBy,jdbcType=BIGINT}, now(), now()
        )
    </insert>
    <update id="updateByPrimaryKey" parameterType="com.lifetech.dhap.pathcloud.dehydrate.domain.model.Dehydrator">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Tue Dec 13 16:37:30 CST 2016.
        -->
        update dehydrator
        set instrument_id = #{instrumentId,jdbcType=BIGINT},
        status = #{status,jdbcType=INTEGER},
        used_block = #{usedBlock,jdbcType=INTEGER},
        capacity = #{capacity,jdbcType=INTEGER},
        reset_time = #{resetTime,jdbcType=TIMESTAMP},
        start_time = #{startTime,jdbcType=TIMESTAMP},
        end_time = #{endTime,jdbcType=TIMESTAMP},
        update_by = #{updateBy,jdbcType=BIGINT},
        update_time = now()
        where id = #{id,jdbcType=BIGINT}
    </update>
    <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="BaseResultMap">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Tue Dec 13 16:37:30 CST 2016.
        -->
        select id, instrument_id, status, used_block, capacity, reset_time, start_time, end_time,
        create_by, update_by, create_time, update_time
        from dehydrator
        where id = #{id,jdbcType=BIGINT}
    </select>
    <select id="selectAll" resultMap="BaseResultMap">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Tue Dec 13 16:37:30 CST 2016.
        -->
        select id, instrument_id, status, used_block, capacity, reset_time, start_time, end_time,
        create_by, update_by, create_time, update_time
        from dehydrator
    </select>

    <resultMap id="InfoMap" type="com.lifetech.dhap.pathcloud.dehydrate.application.dto.DehydratorDto">
        <id column="id" jdbcType="BIGINT" property="id"/>
        <result column="instrument_id" jdbcType="BIGINT" property="instrumentId"/>
        <result column="name" jdbcType="VARCHAR" property="name"/>
        <result column="sn" jdbcType="VARCHAR" property="sn"/>
        <result column="capacity" jdbcType="INTEGER" property="capacity"/>
        <result column="description" jdbcType="VARCHAR" property="description"/>
        <result column="used_block" jdbcType="INTEGER" property="usedBlock"/>
        <result column="reset_time" jdbcType="TIMESTAMP" property="lastClear"/>
        <result column="in_use" jdbcType="BIT" property="inUse"/>
        <result column="disabled" jdbcType="BIT" property="disabled"/>
        <result column="status" jdbcType="INTEGER" property="status"/>
    </resultMap>

    <select id="selectByInstrumentId" parameterType="long" resultMap="BaseResultMap">
    select id, instrument_id, status, used_block, capacity, reset_time, start_time, end_time, 
    create_by, update_by, create_time, update_time
    from dehydrator
    where instrument_id = #{instrumentId,jdbcType=BIGINT}
  </select>

    <delete id="deleteByInstrumentId" parameterType="java.lang.Long">
    delete from dehydrator
    where instrument_id = #{instrumentId,jdbcType=BIGINT}
  </delete>

    <resultMap id="StatusMap" type="com.lifetech.dhap.pathcloud.dehydrate.application.dto.DehydratorStatusDto">
        <id column="id" jdbcType="BIGINT" property="id"/>
        <result column="instrument_id" jdbcType="BIGINT" property="instrumentId"/>
        <result column="name" jdbcType="VARCHAR" property="name"/>
        <result column="sn" jdbcType="VARCHAR" property="sn"/>
        <result column="capacity" jdbcType="INTEGER" property="capacity"/>
        <result column="description" jdbcType="VARCHAR" property="description"/>
        <result column="used_block" jdbcType="INTEGER" property="usedBlock"/>
        <result column="reset_time" jdbcType="TIMESTAMP" property="lastClear"/>
        <result column="in_use" jdbcType="BIT" property="inUse"/>
        <result column="disabled" jdbcType="BIT" property="disabled"/>
        <result column="msg" jdbcType="VARCHAR" property="errMsg"/>
        <result column="occur_time" jdbcType="TIMESTAMP" property="latestErrTime"/>
        <result column="level" jdbcType="INTEGER" property="errLevel"/>
    </resultMap>

    <select id="selectAllStatus" resultMap="StatusMap">
  	SELECT d.status,d.id, d.instrument_id, i.name, i.sn, d.capacity, i.description, d.used_block, d.reset_time, i.in_use, i.disabled, s.msg, s.occur_time, s.level
    FROM dehydrator d 
    	INNER JOIN instrument i ON d.instrument_id = i.id 
    	LEFT JOIN (
            SELECT instrument_id, max(occur_time) occur_time, any_value(msg) msg, any_value(level) level FROM instrument_event
            WHERE level >= 2 AND instrument_id IN (SELECT instrument_id FROM dehydrator) GROUP BY instrument_id
    	) s ON s.instrument_id = i.id ORDER BY (i.name+0)
  </select>

    <select id="selectInfoByCondition" resultMap="InfoMap"
            parameterType="com.lifetech.dhap.pathcloud.dehydrate.application.condition.DehydratorCondition">
        select d.id, d.instrument_id, i.name, i.sn, d.capacity, i.description, d.used_block, i.in_use, i.disabled,d.status
        from dehydrator d INNER JOIN instrument i ON d.instrument_id = i.id

        <where>
            <if test="inUse != null">i.in_use = #{inUse,jdbcType=BIT}</if>
            <if test="disabled != null">and i.disabled = #{disabled,jdbcType=BIT}</if>
            <if test="status != null">and d.status = #{status,jdbcType=INTEGER}</if>
        </where>
        ORDER BY (i.name+0)
        limit #{start,jdbcType=INTEGER}, #{size,jdbcType=INTEGER}
    </select>

    <select id="countInfoByCondition" resultType="java.lang.Long"
            parameterType="com.lifetech.dhap.pathcloud.dehydrate.application.condition.DehydratorCondition">
        select count(1) from dehydrator d INNER JOIN instrument i ON d.instrument_id = i.id
        <where>
            <if test="inUse != null">i.in_use = #{inUse,jdbcType=BIT}</if>
            <if test="disabled != null">and i.disabled = #{disabled,jdbcType=BIT}</if>
            <if test="status != null">and d.status = #{status,jdbcType=INTEGER}</if>
        </where>
    </select>

    <select id="last" resultType="long" useCache="false">
    SELECT LAST_INSERT_ID()
  </select>

    <select id="getLastDehydrator" resultMap="InfoMap" parameterType="java.lang.Long">
    SELECT d.id, d.instrument_id, i.name, i.sn, d.capacity, i.description, d.used_block, d.reset_time, i.in_use, i.disabled
    FROM dehydrator d INNER JOIN instrument i ON d.instrument_id = i.id AND d.id=#{id,jdbcType=BIGINT}
  </select>

    <select id="selectBlockInfoByCondition" resultType="com.lifetech.dhap.pathcloud.dehydrate.domain.model.BlockInfo"
            parameterType="com.lifetech.dhap.pathcloud.dehydrate.application.condition.GetBlockCondition">
    select p.serial_number as pathNo,b.sub_id as subId,a.patient_name as patientName,b.count,b.unit,b.biaoshi,b.`status`,t.instrument_id as instrumentId,
        i.name as instrumentName from block b
    INNER JOIN tracking t on t.block_id=b.id and t.operation=3
    INNER JOIN pathology p on p.id = b.path_id
    INNER JOIN application a on a.pathology_id = p.id
    INNER JOIN instrument i on i.id = t.instrument_id
    WHERE b.status=13 and t.instrument_id= #{instrumentId,jdbcType=BIGINT}
    LIMIT #{start,jdbcType=INTEGER}, #{size,jdbcType=INTEGER}
    </select>
</mapper>