<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.lifetech.dhap.pathcloud.application.domain.BlockIhcRepository">
    <resultMap id="BaseResultMap" type="com.lifetech.dhap.pathcloud.application.domain.model.BlockIhc">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Fri Mar 31 16:25:57 CST 2017.
        -->
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="ihc_id" property="ihcId" jdbcType="BIGINT"/>
        <result column="serial_number" property="serialNumber" jdbcType="CHAR"/>
        <result column="number" property="number" jdbcType="CHAR"/>
        <result column="path_id" property="pathId" jdbcType="BIGINT"/>
        <result column="sub_id" property="subId" jdbcType="VARCHAR"/>
        <result column="block_id" property="blockId" jdbcType="BIGINT"/>
        <result column="status" property="status" jdbcType="INTEGER"/>
        <result column="source" property="source" jdbcType="INTEGER"/>
        <result column="special_dye" property="specialDye" jdbcType="INTEGER"/>
        <result column="ihc_marker" property="ihcMarker" jdbcType="VARCHAR"/>
        <result column="note" property="note" jdbcType="VARCHAR"/>
        <result column="result" property="result" jdbcType="LONGVARCHAR"/>
        <result column="create_by" property="createBy" jdbcType="BIGINT"/>
        <result column="update_by" property="updateBy" jdbcType="BIGINT"/>
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="update_time" property="updateTime" jdbcType="TIMESTAMP"/>
    </resultMap>
    <delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Fri Mar 31 16:25:57 CST 2017.
        -->
        delete from block_ihc
        where id = #{id,jdbcType=BIGINT}
    </delete>
    <insert id="insert" parameterType="com.lifetech.dhap.pathcloud.application.domain.model.BlockIhc">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Fri Mar 31 16:25:57 CST 2017.
        -->
        insert into block_ihc (ihc_id, serial_number,number,
        path_id, sub_id, block_id, source,
        status, special_dye, ihc_marker,
        note,result, create_by, update_by,
        create_time, update_time)
        values (#{ihcId,jdbcType=BIGINT}, #{serialNumber,jdbcType=CHAR},#{number,jdbcType=CHAR},
        #{pathId,jdbcType=BIGINT}, #{subId,jdbcType=VARCHAR}, #{blockId,jdbcType=BIGINT}, #{source,jdbcType=INTEGER},
        #{status,jdbcType=INTEGER}, #{specialDye,jdbcType=INTEGER}, #{ihcMarker,jdbcType=VARCHAR},
        #{note,jdbcType=VARCHAR}, #{result,jdbcType=LONGVARCHAR},#{createBy,jdbcType=BIGINT},
        #{createBy,jdbcType=BIGINT},
        now(), now())
    </insert>
    <update id="updateByPrimaryKey" parameterType="com.lifetech.dhap.pathcloud.application.domain.model.BlockIhc">
    update block_ihc
    set
      status = #{status,jdbcType=INTEGER},
    number = #{number,jdbcType=CHAR},
      update_by = #{updateBy,jdbcType=BIGINT},
      update_time = now()
    where id = #{id,jdbcType=BIGINT}
  </update>
    <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Fri Mar 31 16:25:57 CST 2017.
        -->
        select id, ihc_id, serial_number,number, path_id, sub_id, block_id, status, special_dye,
        ihc_marker, note,result, create_by, update_by, create_time, update_time,source
        from block_ihc
        where id = #{id,jdbcType=BIGINT}
    </select>

    <select id="selectByNumber" resultMap="BaseResultMap" parameterType="java.lang.String">
    select id, ihc_id, serial_number,number, path_id, sub_id, block_id, status, special_dye,
    ihc_marker, note, result,create_by, update_by, create_time, update_time,source
    from block_ihc
    where number = #{number,jdbcType=CHAR}
  </select>

    <select id="selectAll" resultMap="BaseResultMap">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Fri Mar 31 16:25:57 CST 2017.
        -->
        select id, ihc_id, serial_number, number,path_id, sub_id, block_id, status, special_dye,
        ihc_marker, note, create_by, update_by, create_time, update_time,source
        from block_ihc
    </select>

    <resultMap id="ExtendMap" type="com.lifetech.dhap.pathcloud.application.domain.model.BlockIhcExtend">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="ihc_id" property="ihcId" jdbcType="BIGINT"/>
        <result column="serial_number" property="serialNumber" jdbcType="CHAR"/>
        <result column="number" property="number" jdbcType="CHAR"/>
        <result column="path_id" property="pathId" jdbcType="BIGINT"/>
        <result column="sub_id" property="subId" jdbcType="VARCHAR"/>
        <result column="block_id" property="blockId" jdbcType="BIGINT"/>
        <result column="status" property="status" jdbcType="INTEGER"/>
        <result column="source" property="source" jdbcType="INTEGER"/>
        <result column="special_dye" property="specialDye" jdbcType="INTEGER"/>
        <result column="ihc_marker" property="ihcMarker" jdbcType="VARCHAR"/>
        <result column="note" property="note" jdbcType="VARCHAR"/>
        <result column="create_by" property="createBy" jdbcType="BIGINT"/>
        <result column="update_by" property="updateBy" jdbcType="BIGINT"/>
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="update_time" property="updateTime" jdbcType="TIMESTAMP"/>
        <result column="apply_user" property="applyUser" jdbcType="VARCHAR"/>
        <result column="apply_tel" property="applyTel" jdbcType="VARCHAR"/>
        <result column="result" property="result" jdbcType="LONGVARCHAR"/>
    </resultMap>
    <select id="selectByCondition" resultMap="ExtendMap"
            parameterType="com.lifetech.dhap.pathcloud.application.application.condition.IhcBlockCondition">
        select bi.id, bi.ihc_id, bi.serial_number,bi.number, bi.path_id, bi.sub_id, bi.block_id, bi.status,
        bi.special_dye,
        bi.ihc_marker, bi.note, bi.create_by, bi.update_by, bi.create_time, bi.update_time,
        ai.apply_user,ai.apply_tel,bi.result,bi.source
        from block_ihc bi
        INNER JOIN application_ihc ai on bi.ihc_id = ai.id
        <where>
            status != 3
            <if test="ihcId != null">and ihc_id = #{ihcId,jdbcType=BIGINT}</if>
            <if test="pathId != null">and path_id = #{pathId,jdbcType=BIGINT}</if>
            <if test="specialDye != null and specialDye &lt;= 1">and special_dye = #{specialDye,jdbcType=INTEGER}</if>
            <if test="specialDye != null and specialDye > 1">and special_dye > 1</if>
            <if test="blockId != null">and block_id = #{blockId,jdbcType=BIGINT}</if>
        </where>
        <if test="order != null">ORDER BY ${order}</if>
    </select>

    <select id="getApplicationIHCs"
            parameterType="com.lifetech.dhap.pathcloud.application.application.condition.ApplicationIhcCondition"
            resultType="com.lifetech.dhap.pathcloud.application.application.dto.IhcApplicationQueryDto">
        SELECT bi.id as id,bi.serial_number as serialNumber,bi.number,bi.sub_id as subId,bi.special_dye as
        dyeCategory,bi.ihc_marker as ihcMarker,
        bi.note as Note,ai.apply_user as applyUser,ai.apply_tel as phone,ai.create_time as applyTime,bi.`status` as
        status ,b.status as blockStatus,bi.result,bi.source
        FROM `block_ihc` bi
        INNER JOIN application_ihc ai ON bi.ihc_id=ai.id
        LEFT JOIN block b on b.id=bi.block_id and bi.`status`=2
        <where>
            <if test="filter != null">AND (bi.serial_number = #{filter,jdbcType=VARCHAR} OR
                ai.apply_user LIKE CONCAT(#{filter,jdbcType=VARCHAR},'%'))
            </if>
            <if test="createTimeStart != null">AND ai.create_time >= #{createTimeStart,jdbcType=TIMESTAMP}</if>
            <if test="createTimeEnd != null"><![CDATA[AND ai.create_time < #{createTimeEnd,jdbcType=TIMESTAMP}]]></if>
            <if test="dyeCategory != null and dyeCategory != 100">and bi.special_dye = #{dyeCategory,jdbcType=BIGINT}
            </if>
            <if test="dyeCategory == 100">and bi.special_dye IS NULL</if>
            <if test="applicationIhcId != null">and ai.id = #{applicationIhcId,jdbcType=BIGINT}</if>
        </where>
        <if test="order != null">ORDER BY ${order}</if>
        limit #{start,jdbcType=INTEGER},#{size,jdbcType=INTEGER}
    </select>

    <select id="getApplicationIHCsTotal"
            parameterType="com.lifetech.dhap.pathcloud.application.application.condition.ApplicationIhcCondition"
            resultType="java.lang.Long">
        SELECT COUNT(1)
        FROM `block_ihc` bi
        INNER JOIN application_ihc ai ON bi.ihc_id=ai.id
        LEFT JOIN block b on b.id=bi.block_id and bi.`status`=2
        <where>
            <if test="filter != null">AND (bi.serial_number = #{filter,jdbcType=VARCHAR} OR
                ai.apply_user LIKE CONCAT(#{filter,jdbcType=VARCHAR},'%'))
            </if>
            <if test="createTimeStart != null">AND ai.create_time >= #{createTimeStart,jdbcType=TIMESTAMP}</if>
            <if test="createTimeEnd != null"><![CDATA[AND ai.create_time < #{createTimeEnd,jdbcType=TIMESTAMP}]]></if>
            <if test="dyeCategory != null and dyeCategory != 100">and bi.special_dye = #{dyeCategory,jdbcType=BIGINT}
            </if>
            <if test="dyeCategory == 100">and bi.special_dye IS NULL</if>
            <if test="applicationIhcId != null">and ai.id = #{applicationIhcId,jdbcType=BIGINT}</if>
        </where>
        <if test="order != null">ORDER BY ${order}</if>
    </select>

    <select id="getIHCs" resultType="com.lifetech.dhap.pathcloud.application.application.dto.IhcApplicationQueryDto"
            parameterType="com.lifetech.dhap.pathcloud.application.application.condition.ApplicationIhcCondition">
        SELECT bi.id as id,bi.serial_number as serialNumber,bi.number,bi.sub_id as subId,bi.special_dye as
        dyeCategory,ihc_marker as ihcMarker,bi.note,
        ai.apply_user as applyUser,ai.create_time as applyTime,bi.result,bi.source,bi.status,b.status as
        blockStatus,b.update_time as updateTime,
        b.update_by as updateBy
        FROM block_ihc bi
        INNER JOIN application_ihc ai ON bi.ihc_id=ai.id
        INNER JOIN block b ON bi.block_id=b.id
        <where>
            bi.status != 3 /*已撤销*/
            <if test="filter != null">AND (bi.serial_number = #{filter,jdbcType=VARCHAR} OR
                ai.apply_user LIKE CONCAT(#{filter,jdbcType=VARCHAR},'%'))
            </if>
            <if test="createTimeStart != null">AND ai.create_time >= #{createTimeStart,jdbcType=TIMESTAMP}</if>
            <if test="createTimeEnd != null"><![CDATA[AND ai.create_time < #{createTimeEnd,jdbcType=TIMESTAMP}]]></if>
            <if test="dyeCategory == 1">AND bi.special_dye = #{dyeCategory,jdbcType=INTEGER}</if>
            <if test="dyeCategory == 2">AND bi.special_dye > 1</if>
            <if test="status != null">AND bi.status = #{status,jdbcType=INTEGER}</if>
            <if test="blockStatus != null">AND b.status = #{blockStatus,jdbcType=INTEGER}</if>
        </where>
        <if test="order != null">ORDER BY ${order}</if>
        limit #{start,jdbcType=INTEGER},#{size,jdbcType=INTEGER}
    </select>

    <select id="getIHCsTotal"
            parameterType="com.lifetech.dhap.pathcloud.application.application.condition.ApplicationIhcCondition"
            resultType="java.lang.Long">
        SELECT COUNT(1)
        FROM block_ihc bi
        INNER JOIN application_ihc ai ON bi.ihc_id=ai.id
        INNER JOIN block b ON bi.block_id=b.id
        <where>
            bi.status != 3 /*已撤销*/
            <if test="filter != null">AND (bi.serial_number = #{filter,jdbcType=VARCHAR} OR
                ai.apply_user LIKE CONCAT(#{filter,jdbcType=VARCHAR},'%'))
            </if>
            <if test="createTimeStart != null">AND ai.create_time >= #{createTimeStart,jdbcType=TIMESTAMP}</if>
            <if test="createTimeEnd != null"><![CDATA[AND ai.create_time < #{createTimeEnd,jdbcType=TIMESTAMP}]]></if>
            <if test="dyeCategory == 1">AND bi.special_dye = #{dyeCategory,jdbcType=INTEGER}</if>
            <if test="dyeCategory == 2">AND bi.special_dye > 1</if>
            <if test="status != null">AND bi.status = #{status,jdbcType=INTEGER}</if>
            <if test="blockStatus != null">AND b.status = #{blockStatus,jdbcType=INTEGER}</if>
        </where>
        <if test="order != null">ORDER BY ${order}</if>
    </select>

    <select id="selectCurrentIhcIdsByBlockId" parameterType="java.lang.Long" resultType="java.lang.Long">
    select DISTINCT (ihc_id) from block_ihc where block_id =  #{blockId,jdbcType=BIGINT} and status = 4/*执行中*/
  </select>

    <select id="last" resultType="long" useCache="false">
    SELECT LAST_INSERT_ID()
  </select>

    <update id="updateStatus" parameterType="java.util.Map">
        update block_ihc set status =#{status,jdbcType=INTEGER},update_by=#{updateBy,jdbcType=BIGINT},update_time=now()
        where id IN
        <foreach collection="blockIhcIds" item="item" index="index" open="(" separator="," close=")">
            #{item}
        </foreach>
    </update>


    <select id="getPrintIhcs"
            parameterType="com.lifetech.dhap.pathcloud.application.application.condition.PrintIhcCondition"
            resultType="com.lifetech.dhap.pathcloud.application.application.dto.PrintIhcsDetailDto">
        SELECT * FROM (
        select blockIhcId,blockId,serialNumber,subId,specialDye,reagent,applyDoctor,bis.note,bis.createTime
        ,id as slideId,IFNULL(print,0) as count,trackingId,bis.number from (
        SELECT blockIhcId,
        REPLACE (SUBSTRING_INDEX(
        SUBSTRING_INDEX(SUBSTR(SUBSTRING_INDEX(reagent,']',1),2), ',', seq),',' ,- 1),'"','') reagent,
        blockId,serialNumber,subId,specialDye,applyDoctor,note,createTime,trackingId,number
        FROM ihc_marker_index
        CROSS JOIN
        (SELECT bi.id as blockIhcId,bi.block_id as blockId,bi.serial_number as serialNumber,bi.sub_id as subId,
        bi.special_dye as specialDye,bi.ihc_marker as reagent, ai.apply_user as applyDoctor,bi.note as note,
        t.create_time as createTime,t1.id as trackingId,bi.number
        FROM block_ihc bi
        INNER JOIN application_ihc ai ON bi.ihc_id=ai.id
        INNER JOIN tracking t on t.block_id=bi.block_id AND t.operation=18
        INNER JOIN tracking t1 on t1.instrument_id = bi.id and t1.operation=30
        where bi.`status`>=4
        ORDER BY t.create_time desc) as block_ihc
        WHERE
        seq BETWEEN 1
        AND (
        SELECT
        1 + LENGTH(SUBSTR(SUBSTRING_INDEX(reagent,']',1),2)) - LENGTH(REPLACE(SUBSTR(SUBSTRING_INDEX(reagent,']',1),2),
        ',', ''))
        )
        ORDER BY
        blockIhcId,
        SUBSTR(SUBSTRING_INDEX(reagent,']',1),2)) as bis
        LEFT JOIN block on bis.trackingId = block.apply_id and bis.reagent=block.marker
        GROUP BY blockId,reagent
        ORDER BY createTime desc
        ) t
        <where>
            <if test="filter != null">AND serialNumber = #{filter,jdbcType=VARCHAR}</if>
            <if test="specialDye == 1">and specialDye = #{specialDye,jdbcType=INTEGER}</if>
            <if test="specialDye == 2">and specialDye > 1</if>
            <if test="count == 0">and count = #{count,jdbcType=INTEGER}</if>
            <if test="count != null and count != 0">and count > 0</if>
            <if test="createTimeStart != null">and createTime >= #{createTimeStart,jdbcType=TIMESTAMP}</if>
            <if test="createTimeEnd != null"><![CDATA[and createTime < #{createTimeEnd,jdbcType=TIMESTAMP}]]></if>
        </where>
        ORDER  BY createTime DESC
        limit #{start,jdbcType=INTEGER},#{size,jdbcType=INTEGER}
    </select>

    <select id="getPrintIhcsTotal"
            parameterType="com.lifetech.dhap.pathcloud.application.application.condition.PrintIhcCondition"
            resultType="java.lang.Long">
        SELECT count(1) FROM (
        select blockIhcId,blockId,serialNumber,subId,specialDye,reagent,applyDoctor,bis.note,bis.createTime
        ,id as slideId,IFNULL(print,0) as count,trackingId from (
        SELECT blockIhcId,
        REPLACE (SUBSTRING_INDEX(
        SUBSTRING_INDEX(SUBSTR(SUBSTRING_INDEX(reagent,']',1),2), ',', seq),',' ,- 1),'"','') reagent,
        blockId,serialNumber,subId,specialDye,applyDoctor,note,createTime,trackingId
        FROM ihc_marker_index
        CROSS JOIN
        (SELECT bi.id as blockIhcId,bi.block_id as blockId,bi.serial_number as serialNumber,bi.sub_id as subId,
        bi.special_dye as specialDye,bi.ihc_marker as reagent, ai.apply_user as applyDoctor,bi.note as note,
        t.create_time as createTime,t1.id as trackingId
        FROM block_ihc bi
        INNER JOIN application_ihc ai ON bi.ihc_id=ai.id
        INNER JOIN tracking t on t.block_id=bi.block_id AND t.operation=18
        INNER JOIN tracking t1 on t1.instrument_id = bi.id and t1.operation=30
        where bi.`status`>=4
        ORDER BY t.create_time desc) as block_ihc
        WHERE
        seq BETWEEN 1
        AND (
        SELECT
        1 + LENGTH(SUBSTR(SUBSTRING_INDEX(reagent,']',1),2)) - LENGTH(REPLACE(SUBSTR(SUBSTRING_INDEX(reagent,']',1),2),
        ',', ''))
        )
        ORDER BY
        blockIhcId,
        SUBSTR(SUBSTRING_INDEX(reagent,']',1),2)) as bis
        LEFT JOIN block on bis.trackingId = block.apply_id and bis.reagent=block.marker
        GROUP BY blockId,reagent
        ORDER BY createTime desc
        ) t
        <where>
            <if test="filter != null">AND serialNumber = #{filter,jdbcType=VARCHAR}</if>
            <if test="specialDye == 1">and specialDye = #{specialDye,jdbcType=INTEGER}</if>
            <if test="specialDye == 2">and specialDye > 1</if>
            <if test="count == 0">and count = #{count,jdbcType=INTEGER}</if>
            <if test="count != null and count != 0">and count > 0</if>
            <if test="createTimeStart != null">and createTime >= #{createTimeStart,jdbcType=TIMESTAMP}</if>
            <if test="createTimeEnd != null"><![CDATA[and createTime < #{createTimeEnd,jdbcType=TIMESTAMP}]]></if>
        </where>
    </select>

    <select id="selectMinSlideStatusByTracingId" resultType="java.lang.Integer" parameterType="java.lang.Long">
    SELECT min(b.status) FROM block b
    INNER JOIN tracking t on b.apply_id = t.id
    WHERE b.parent_id IS NOT NULL AND b.apply_id = #{trackingId,jdbcType=BIGINT}
  </select>

    <select id="selectIdByMarkerAndBlockId" resultType="java.lang.Long" parameterType="java.util.Map">
select id from (
SELECT
        id,
        REPLACE (SUBSTRING_INDEX(
            SUBSTRING_INDEX(SUBSTR(SUBSTRING_INDEX(ihc_marker,']',1),2), ',', seq),',' ,- 1),'"','') ihc_marker,block_id,status
    FROM
        ihc_marker_index
    CROSS JOIN block_ihc
    WHERE
        seq BETWEEN 1
    AND (
        SELECT
            1 + LENGTH(SUBSTR(SUBSTRING_INDEX(ihc_marker,']',1),2)) - LENGTH(REPLACE(SUBSTR(SUBSTRING_INDEX(ihc_marker,']',1),2), ',', ''))
    )
    ORDER BY
        id,
        SUBSTR(SUBSTRING_INDEX(ihc_marker,']',1),2)
) as t
where block_id = #{blockId,jdbcType=BIGINT} and ihc_marker=#{marker,jdbcType=VARCHAR} and status != 3/*已撤销*/
  </select>
</mapper>