<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lifetech.dhap.pathcloud.tracking.domain.BlockArchiveRepository">
  <resultMap id="BaseResultMap" type="com.lifetech.dhap.pathcloud.tracking.domain.model.BlockArchive">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Jun 07 15:18:21 CST 2017.
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="serial_number" jdbcType="CHAR" property="serialNumber" />
    <result column="path_id" jdbcType="BIGINT" property="pathId" />
    <result column="block_sub_id" jdbcType="VARCHAR" property="blockSubId" />
    <result column="block_id" jdbcType="BIGINT" property="blockId" />
    <result column="slide_id" jdbcType="BIGINT" property="slideId" />
    <result column="slide_sub_id" jdbcType="VARCHAR" property="slideSubId" />
    <result column="status" jdbcType="INTEGER" property="status" />
    <result column="ihc_marker" jdbcType="VARCHAR" property="ihcMarker" />
    <result column="patient_name" jdbcType="VARCHAR" property="patientName" />
    <result column="archive_box" jdbcType="VARCHAR" property="archiveBox" />
    <result column="archive_index" jdbcType="VARCHAR" property="archiveIndex" />
    <result column="create_by" jdbcType="BIGINT" property="createBy" />
    <result column="update_by" jdbcType="BIGINT" property="updateBy" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="update_time" jdbcType="TIMESTAMP" property="updateTime" />
  </resultMap>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Jun 07 15:18:21 CST 2017.
    -->
    delete from block_archive
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="com.lifetech.dhap.pathcloud.tracking.domain.model.BlockArchive">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Jun 07 15:18:21 CST 2017.
    -->
    insert into block_archive (serial_number, path_id,
      block_sub_id, block_id, slide_id, 
      slide_sub_id, status, ihc_marker, 
      patient_name, archive_box, archive_index, 
      create_by, update_by, create_time, 
      update_time)
    values (#{serialNumber,jdbcType=CHAR}, #{pathId,jdbcType=BIGINT},
      #{blockSubId,jdbcType=VARCHAR}, #{blockId,jdbcType=BIGINT}, #{slideId,jdbcType=BIGINT}, 
      #{slideSubId,jdbcType=VARCHAR}, #{status,jdbcType=INTEGER}, #{ihcMarker,jdbcType=VARCHAR}, 
      #{patientName,jdbcType=VARCHAR}, #{archiveBox,jdbcType=VARCHAR}, #{archiveIndex,jdbcType=VARCHAR}, 
      #{createBy,jdbcType=BIGINT}, #{createBy,jdbcType=BIGINT},now(),
      now())
  </insert>
  <update id="updateByPrimaryKey" parameterType="com.lifetech.dhap.pathcloud.tracking.domain.model.BlockArchive">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Jun 07 15:18:21 CST 2017.
    -->
    update block_archive
    <set>
      <if test="serialNumber != null">serial_number = #{serialNumber,jdbcType=CHAR},</if>
      <if test="pathId != null">path_id = #{pathId,jdbcType=BIGINT},</if>
      <if test="blockSubId != null">block_sub_id = #{blockSubId,jdbcType=VARCHAR},</if>
      <if test="blockId != null">block_id = #{blockId,jdbcType=BIGINT},</if>
      <if test="slideId != null">slide_id = #{slideId,jdbcType=BIGINT},</if>
      <if test="slideSubId != null">slide_sub_id = #{slideSubId,jdbcType=VARCHAR},</if>
      <if test="status != null">status = #{status,jdbcType=INTEGER},</if>
      <if test="ihcMarker != null">ihc_marker = #{ihcMarker,jdbcType=VARCHAR},</if>
      <if test="patientName != null">patient_name = #{patientName,jdbcType=VARCHAR},</if>
      <if test="archiveBox != null">archive_box = #{archiveBox,jdbcType=VARCHAR},</if>
      <if test="archiveIndex != null">archive_index = #{archiveIndex,jdbcType=VARCHAR},</if>
      <if test="updateBy != null">update_by = #{updateBy,jdbcType=BIGINT},</if>
      update_time = now()
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Jun 07 15:18:21 CST 2017.
    -->
    select id, serial_number, path_id, block_sub_id, block_id, slide_id, slide_sub_id, 
    status, ihc_marker, patient_name, archive_box, archive_index, create_by, update_by, 
    create_time, update_time
    from block_archive
    where id = #{id,jdbcType=BIGINT}
  </select>
  <select id="selectAll" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Jun 07 15:18:21 CST 2017.
    -->
    select id, serial_number, path_id, block_sub_id, block_id, slide_id, slide_sub_id, 
    status, ihc_marker, patient_name, archive_box, archive_index, create_by, update_by, 
    create_time, update_time
    from block_archive
  </select>

  <resultMap id="slideMap" type="com.lifetech.dhap.pathcloud.tracking.domain.model.Slide">
    <id column="id" property="id" jdbcType="BIGINT"/>
    <result column="serial_number" property="serialNumber" jdbcType="CHAR"/>
    <result column="path_id" property="pathId" jdbcType="BIGINT"/>
    <result column="parent_id" property="parentId" jdbcType="BIGINT"/>
    <result column="marker" property="marker" jdbcType="VARCHAR"/>
    <result column="sub_id" property="subId" jdbcType="VARCHAR"/>
    <result column="biaoshi" property="biaoshi" jdbcType="INTEGER"/>
    <result column="body_part" property="bodyPart" jdbcType="VARCHAR"/>
    <result column="count" property="count" jdbcType="INTEGER"/>
    <result column="unit" property="unit" jdbcType="INTEGER"/>
    <result column="print" property="print" jdbcType="BIT"/>
    <result column="deep_section" property="deepSection" jdbcType="BIT"/>
    <result column="special_dye" property="specialDye" jdbcType="INTEGER"/>
    <result column="status" property="status" jdbcType="INTEGER"/>
    <result column="create_by" property="createBy" jdbcType="BIGINT"/>
    <result column="update_by" property="updateBy" jdbcType="BIGINT"/>
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
    <result column="update_time" property="updateTime" jdbcType="TIMESTAMP"/>
    <result column="note" property="note" jdbcType="LONGVARCHAR"/>
    <result column="path_no" property="pathNo" jdbcType="VARCHAR"/>
    <result column="block_no" property="blockSerialNumber" jdbcType="VARCHAR"/>
    <result column="block_sub_id" property="blockSubId" jdbcType="VARCHAR"/>
    <result column="receiver" property="receiver" jdbcType="VARCHAR"/>
    <result column="receive_time" property="receiveTime" jdbcType="TIMESTAMP"/>
    <result column="confirm_user" property="confirmUser" jdbcType="TIMESTAMP"/>
    <result column="apply_id" property="applyId" jdbcType="BIGINT"/>
  </resultMap>

  <select id="selectInfoForArchiveByCondition" resultMap="slideMap"
          parameterType="com.lifetech.dhap.pathcloud.tracking.application.condition.ArchiveCondition">
    SELECT b.id,b.parent_id,b.serial_number,b.sub_id,b.path_id,b.biaoshi,b.special_dye,b.marker,bb.serial_number as block_no,
    bb.sub_id as block_sub_id ,p.serial_number as path_no,IFNULL(ba.status,b.status) as status
    FROM block b
    LEFT JOIN block bb on b.parent_id = bb.id
    INNER JOIN pathology p on b.path_id = p.id
    LEFT JOIN block_archive ba on ba.slide_id = b.id
    WHERE   b.parent_id IS NOT NULL and (b.status = 28 or b.status=29)/*待存档或已存档*/
    and (b.id not in (select slide_id from block_archive) or (b.id in (select slide_id from block_archive where status != 2)))
    <if test="pathNo != null"> AND p.serial_number =  #{pathNo,jdbcType=VARCHAR}</if>
    <if test="blockSubId != null"> AND bb.sub_id =  #{blockSubId,jdbcType=VARCHAR}</if>
    <if test="slideSubId != null"> AND b.sub_id =  #{slideSubId,jdbcType=VARCHAR}</if>
    <if test="marker != null"> AND b.marker =  #{marker,jdbcType=VARCHAR}</if>
  </select>

  <select id="selectBySlideId" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    select id, serial_number, path_id, block_sub_id, block_id, slide_id, slide_sub_id,ihc_marker, patient_name,
    status, archive_box, archive_index, create_by, update_by, create_time, update_time
    from block_archive
    where slide_id = #{slideId,jdbcType=BIGINT}
  </select>

  <select id="selectInfoForBorrowByCondition" resultMap="BaseResultMap" parameterType="com.lifetech.dhap.pathcloud.tracking.application.condition.ArchiveCondition">
    select id, serial_number, path_id, block_sub_id, block_id, slide_id, slide_sub_id,status, archive_box, archive_index, create_by, update_by, create_time, update_time,ihc_marker, patient_name
    from block_archive
    WHERE   status != 2  /*借出*/
    <if test="pathNo != null"> AND serial_number =  #{pathNo,jdbcType=VARCHAR}</if>
    <if test="blockSubId != null"> AND block_sub_id =  #{blockSubId,jdbcType=VARCHAR}</if>
    <if test="slideSubId != null"> AND slide_sub_id =  #{slideSubId,jdbcType=VARCHAR}</if>
    <if test="marker != null"> AND ihc_marker =  #{marker,jdbcType=VARCHAR}</if>
  </select>

  <select id="getSlidesArchivingInfo" resultType="com.lifetech.dhap.pathcloud.tracking.application.dto.SlideArchiveInfoDto"
          parameterType="com.lifetech.dhap.pathcloud.tracking.application.condition.SlideArchivingCon">
    SELECT * from (SELECT * from (SELECT ba.id as blockArchiveId,ba.path_id as pathId,ba.block_id as blockId,ba.slide_id as slideId,
    ba.serial_number as serialNumber ,
    ba.block_sub_id as blockSubId, ba.slide_sub_id as slideSubId , ba.ihc_marker as ihcMarker,
    ba.patient_name as patientName,ba.archive_box as archiveBox,ba.create_by as archiveCreateBy,ba.create_time as archiveCreateTime,bb.create_time as createTime
    ,IFNULL(datediff(bb.real_back,bb.plan_back),datediff(NOW(),bb.plan_back)) as overdue,a.apply_type as applyType
    ,ba.status as status,t.note as dryingBox,t.operator_id as dryingCreateBy,t.operation_time as dryingCreateTime,bb.archive_status as archiveStatus,
    t.operator_name as dryingCreateByDesc
    from block_archive ba
    LEFT JOIN block_borrow bb on ba.id=bb.archive_id
    LEFT JOIN pathology p on ba.path_id=p.id
    LEFT JOIN application a ON p.id=a.pathology_id
    left  JOIN tracking t ON t.block_id=ba.slide_id and t.operation=31
    ORDER BY createTime desc
    ) a
    GROUP BY blockArchiveId ) b
    <where>
      <if test="filter != null"> and serialNumber = #{filter,jdbcType=VARCHAR}</if>
      <if test="type != null">and applyType = #{type,jdbcType=INTEGER}</if>
      <if test="status != null and status != 3 and status != 2">and status = #{status,jdbcType=INTEGER}</if>
      <if test="status == 2"><![CDATA[and status = #{status,jdbcType=TIMESTAMP} and overdue <= 0 ]]></if>
      <if test="status == 3 ">and overdue > 0</if>
    </where>
    <if test="order != null">ORDER BY ${order}</if>
    limit #{start,jdbcType=INTEGER}, #{size,jdbcType=INTEGER}

  </select>

  <select id="getSlidesArchivingInfoTotal" resultType="java.lang.Long"
          parameterType="com.lifetech.dhap.pathcloud.tracking.application.condition.SlideArchivingCon">

   SELECT count(1) FROM (SELECT * from (SELECT * from (SELECT ba.id as blockArchiveId,ba.path_id as pathId,ba.block_id as blockId,ba.slide_id as slideId,
    ba.serial_number as serialNumber ,
    ba.block_sub_id as blockSubId, ba.slide_sub_id as slideSubId , ba.ihc_marker as ihcMarker,
    ba.patient_name as patientName,ba.archive_box as archiveBox,ba.create_by as archiveCreateBy,ba.create_time as archiveCreateTime,bb.create_time as createTime
    ,IFNULL(datediff(bb.real_back,bb.plan_back),datediff(NOW(),bb.plan_back)) as overdue,a.apply_type as applyType
    ,ba.status as status,t.note as dryingBox,t.operator_id as dryingCreateBy,t.operation_time as dryingCreateTime,bb.archive_status as archiveStatus,
    t.operator_name as dryingCreateByDesc
    from block_archive ba
    LEFT JOIN block_borrow bb on ba.id=bb.archive_id
    LEFT JOIN pathology p on ba.path_id=p.id
    LEFT JOIN application a ON p.id=a.pathology_id
    left  JOIN tracking t ON t.block_id=ba.slide_id and t.operation=31
    ORDER BY createTime desc
    ) a
    GROUP BY blockArchiveId ) b
    <where>
      <if test="filter != null"> and serialNumber = #{filter,jdbcType=VARCHAR}</if>
      <if test="type != null">and applyType = #{type,jdbcType=INTEGER}</if>
      <if test="status != null and status != 3 and status != 2">and status = #{status,jdbcType=INTEGER}</if>
      <if test="status == 2"><![CDATA[and status = #{status,jdbcType=TIMESTAMP} and overdue <= 0 ]]></if>
      <if test="status == 3 ">and overdue > 0</if>
    </where>) c



  </select>

  <select id="getArchivingInfo" parameterType="java.lang.Long"
          resultType="com.lifetech.dhap.pathcloud.tracking.application.dto.BlockArchiveDto">
    SELECT id as id,serial_number as serialNumber,path_id as pathId , block_sub_id as blockSubId, block_id as blockId,slide_id as slideId

    ,slide_sub_id as slideSubId,`status` as `status`, archive_box as archiveBox , archive_index as archiveIndex,create_time as createTime

    FROM block_archive

    WHERE path_id= #{pid,jdbcType=BIGINT}

  </select>
</mapper>