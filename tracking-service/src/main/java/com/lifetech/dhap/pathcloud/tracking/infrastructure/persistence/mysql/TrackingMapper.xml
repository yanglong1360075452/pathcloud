<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lifetech.dhap.pathcloud.tracking.domain.TrackingRepository">
    <resultMap id="BaseResultMap" type="com.lifetech.dhap.pathcloud.tracking.domain.model.Tracking">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Dec 07 13:36:11 CST 2016.
        -->
        <id column="id" jdbcType="BIGINT" property="id"/>
        <result column="block_id" jdbcType="BIGINT" property="blockId"/>
        <result column="operation" jdbcType="INTEGER" property="operation"/>
        <result column="operator_id" jdbcType="BIGINT" property="operatorId"/>
        <result column="operator_name" jdbcType="VARCHAR" property="operatorName"/>
        <result column="sec_operator_id" jdbcType="BIGINT" property="secOperatorId"/>
        <result column="operation_time" jdbcType="TIMESTAMP" property="operationTime"/>
        <result column="manual_flag" jdbcType="BIT" property="manualFlag"/>
        <result column="instrument_id" jdbcType="INTEGER" property="instrumentId"/>
        <result column="create_by" jdbcType="BIGINT" property="createBy"/>
        <result column="update_by" jdbcType="BIGINT" property="updateBy"/>
        <result column="create_time" jdbcType="TIMESTAMP" property="createTime"/>
        <result column="update_time" jdbcType="TIMESTAMP" property="updateTime"/>
        <result column="note" jdbcType="LONGVARCHAR" property="note"/>
        <result column="note_type" jdbcType="VARCHAR" property="noteType"/>
        <result column="marker" jdbcType="VARCHAR" property="marker"/>
    </resultMap>
    <delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Dec 07 13:36:11 CST 2016.
        -->
        delete from tracking
        where id = #{id,jdbcType=BIGINT}
    </delete>
    <insert id="insert" parameterType="com.lifetech.dhap.pathcloud.tracking.domain.model.Tracking">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Dec 07 13:36:11 CST 2016.
        -->
        insert into tracking (block_id, operation,
        operator_id,operator_name,sec_operator_id, operation_time,
        manual_flag, instrument_id, create_by,
        update_by, create_time, update_time,
        note,note_type)
        values (#{blockId,jdbcType=BIGINT}, #{operation,jdbcType=INTEGER},
        #{operatorId,jdbcType=BIGINT}, #{operatorName,jdbcType=VARCHAR},#{secOperatorId,jdbcType=BIGINT},
        #{operationTime,jdbcType=TIMESTAMP},
        #{manualFlag,jdbcType=BIT}, #{instrumentId,jdbcType=INTEGER}, #{createBy,jdbcType=BIGINT},
        #{createBy,jdbcType=BIGINT}, now(), now(),
        #{note,jdbcType=LONGVARCHAR},#{noteType,jdbcType=VARCHAR}
        )
    </insert>

    <insert id="batchInsert" parameterType="java.util.List">
        insert into tracking (block_id, operation,
        operator_id, operator_name,sec_operator_id, operation_time,
        manual_flag, instrument_id, create_by,
        update_by, create_time, update_time,
        note,note_type) values
        <foreach collection="list" item="item" index="index"
                 separator=",">
            (#{item.blockId,jdbcType=BIGINT}, #{item.operation,jdbcType=INTEGER},
            #{item.operatorId,jdbcType=BIGINT},#{item.operatorName,jdbcType=VARCHAR},
            #{item.secOperatorId,jdbcType=BIGINT}, #{item.operationTime,jdbcType=TIMESTAMP},
            #{item.manualFlag,jdbcType=BIT}, #{item.instrumentId,jdbcType=INTEGER}, #{item.createBy,jdbcType=BIGINT},
            #{item.createBy,jdbcType=BIGINT}, now(), now(),
            #{item.note,jdbcType=LONGVARCHAR},#{item.noteType,jdbcType=VARCHAR}
            )
        </foreach>
    </insert>


    <update id="updateByPrimaryKey" parameterType="com.lifetech.dhap.pathcloud.tracking.domain.model.Tracking">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Dec 07 13:36:11 CST 2016.
        -->
        update tracking
        <set>
            <if test="blockId">block_id = #{blockId,jdbcType=BIGINT},</if>
            <if test="operation">operation = #{operation,jdbcType=INTEGER},</if>
            <if test="operatorId">operator_id = #{operatorId,jdbcType=BIGINT},</if>
            <if test="operatorName">operator_name = #{operatorName,jdbcType=VARCHAR},</if>
            <if test="secOperatorId">sec_operator_id = #{secOperatorId,jdbcType=BIGINT},</if>
            <if test="operationTime">operation_time = #{operationTime,jdbcType=TIMESTAMP},</if>
            <if test="manualFlag">manual_flag = #{manualFlag,jdbcType=BIT},</if>
            <if test="instrumentId">instrument_id = #{instrumentId,jdbcType=INTEGER},</if>
            <if test="updateBy">update_by = #{updateBy,jdbcType=BIGINT},</if>
            <if test="note">note = #{note,jdbcType=LONGVARCHAR},</if>
            <if test="noteType">note_type = #{noteType,jdbcType=VARCHAR},</if>
            update_time = now(),
        </set>
        where id = #{id,jdbcType=BIGINT}
    </update>
    <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="BaseResultMap">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Dec 07 13:36:11 CST 2016.
        -->
        select id, block_id, operation, operator_id,operator_name, sec_operator_id, operation_time, manual_flag,
        instrument_id, create_by, update_by, create_time, update_time, note,note_type
        from tracking
        where id = #{id,jdbcType=BIGINT}
    </select>

    <select id="selectLastEmbedPause" parameterType="java.lang.Long" resultMap="BaseResultMap">
        select id, block_id, operation, operator_id, operator_name,sec_operator_id, operation_time, manual_flag,
        instrument_id, create_by, update_by, create_time, update_time, note,note_type
        from tracking
        where block_id = #{blockId,jdbcType=BIGINT} and (operation= 29 or operation=32) /* 29-包埋暂停 32-取消包埋暂停*/
        order by operation_time desc limit 1
    </select>

    <select id="selectAll" resultMap="BaseResultMap">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Dec 07 13:36:11 CST 2016.
        -->
        select id, block_id, operation, operator_id,operator_name, sec_operator_id, operation_time, manual_flag,
        instrument_id, create_by, update_by, create_time, update_time, note,note_type
        from tracking
    </select>

    <select id="last" resultType="long" useCache="false">
    SELECT LAST_INSERT_ID()
  </select>

    <select id="selectByCondition"
            parameterType="com.lifetech.dhap.pathcloud.tracking.application.condition.TrackingCondition"
            resultMap="BaseResultMap">
        select id, block_id, operation, operator_id,operator_name, sec_operator_id, operation_time, manual_flag,
        instrument_id, create_by, update_by, create_time, update_time, note,note_type
        from tracking
        <where>
            <if test="blockId != null">block_id = #{blockId,jdbcType=BIGINT}</if>
            <if test="blockIdList != null and blockIdList.size() > 0">
                and block_id in
                <foreach collection="blockIdList" item="item" index="index" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="operation != null">and operation = #{operation,jdbcType=INTEGER}</if>
            <if test="operatorId != null">and operator_id = #{operatorId,jdbcType=BIGINT}</if>
            <if test="secOperatorId != null">and sec_operator_id = #{secOperatorId,jdbcType=BIGINT}</if>
            <if test="instrumentId != null">and instrument_id = #{instrumentId,jdbcType=BIGINT}</if>
        </where>
        order by operation_time desc
        limit 1
    </select>

    <select id="selectAllByCondition"
            parameterType="com.lifetech.dhap.pathcloud.tracking.application.condition.TrackingCondition"
            resultMap="BaseResultMap">
        select id, block_id, operation, operator_id,operator_name, sec_operator_id, operation_time, manual_flag,
        instrument_id, create_by, update_by, create_time, update_time, note,note_type
        from tracking
        <where>
            <if test="blockId != null">block_id = #{blockId,jdbcType=BIGINT}</if>
            <if test="operation != null">and operation = #{operation,jdbcType=INTEGER}</if>
            <if test="operatorId != null">and operator_id = #{operatorId,jdbcType=BIGINT}</if>
            <if test="instrumentId != null">and instrument_id = #{instrumentId,jdbcType=BIGINT}</if>
        </where>
    </select>

    <select id="selectTrackingByBasketNumberAndStatus" parameterType="map" resultMap="BaseResultMap">
        select t.* from tracking t
        inner join block t1 on t.block_id = t1.id and t.operation = 1
        where t.instrument_id = #{basketNumber,jdbcType=BIGINT} and t1.status = #{status,jdbcType=INTEGER}
        limit 1
    </select>

    <delete id="deleteByCondition"
            parameterType="com.lifetech.dhap.pathcloud.tracking.application.condition.TrackingCondition">
        delete from tracking
        <where>
            <if test="blockId != null">block_id = #{blockId,jdbcType=BIGINT}</if>
            <if test="operation != null">and operation = #{operation,jdbcType=INTEGER}</if>
            <if test="operatorId != null">and operator_id = #{operatorId,jdbcType=BIGINT}</if>
        </where>
    </delete>

    <select id="selectPrepareDistribute"
            resultType="com.lifetech.dhap.pathcloud.tracking.domain.model.PrepareDistribute"
            parameterType="com.lifetech.dhap.pathcloud.tracking.application.condition.DistributeCondition">
        select p.id as pathId, p.serial_number as serialNumber, count(s.id) as slideTotal, t.operator_id as
        grossingOperator,
        t.operator_name as grossingOperatorName,p.departments, t2.operation_time as confirmTime,
        t2.operator_id as confirmOperator,t2.operator_name as confirmOperatorName,s.status as status
        from pathology p
        inner join block s on p.id = s.path_id and s.status = 19
        inner join tracking t on t.block_id = s.parent_id and t.operation = 1
        inner join tracking t2 on t2.block_id = s.id and t2.operation = 8
        <where>
            <if test="departments != null">p.departments = #{departments,jdbcType=INTEGER}</if>
            <if test="operator != null">and t.operator_id = #{operator,jdbcType=BIGINT}</if>
        </where>
        group by p.id, t.operator_id, t2.operator_id, t2.operation_time
        <if test="order != null">order by ${order}</if>
        limit #{start,jdbcType=INTEGER}, #{size,jdbcType=INTEGER}
    </select>

    <select id="countPrepareDistribute" resultType="java.lang.Long"
            parameterType="com.lifetech.dhap.pathcloud.tracking.application.condition.DistributeCondition">
        select count(DISTINCT p.id)
        from pathology p
        inner join block s on p.id = s.path_id and s.status = 19
        inner join tracking t on t.block_id = s.parent_id and t.operation = 1
        <where>
            <if test="departments != null">p.departments = #{departments,jdbcType=INTEGER}</if>
            <if test="operator != null">and t.operator_id = #{operator,jdbcType=BIGINT}</if>
        </where>
    </select>

    <select id="selectPrepareDistributeIdsByParam" parameterType="java.lang.Long" resultType="java.lang.Long">
      select id from block where path_id = #{pathId,jdbcType=BIGINT} and status = 19
  </select>

    <select id="selectDistributeHistory"
            resultType="com.lifetech.dhap.pathcloud.tracking.domain.model.DistributeHistory"
            parameterType="com.lifetech.dhap.pathcloud.tracking.application.condition.DistributeCondition">
        select p.serial_number as serialNumber, b.sub_id as blockSubId, s.sub_id as slideSubId, t.operator_id as
        grossingOperator,
        t.operator_name as grossingOperatorName,p.departments, t2.operation_time as confirmTime, t2.operator_id as
        confirmOperator,
        t2.operator_name as confirmOperatorName, t3.note as receiver,
        t3.operator_id as distributeOperator,t3.operator_name as distributeOperatorName, t3.operation_time as
        distributeTime
        from pathology p
        inner join block s on p.id = s.path_id
        inner join block b on b.id = s.parent_id
        inner join tracking t on t.block_id = b.id and t.operation = 1
        inner join tracking t2 on t2.block_id = s.id and t2.operation = 8
        inner join tracking t3 on t3.block_id = s.id and t3.operation = 9
        <where>
            <if test="departments != null">p.departments = #{departments,jdbcType=INTEGER}</if>
            <if test="operator != null">and t.operator_id = #{operator,jdbcType=BIGINT}</if>
            <if test="timeStart != null">and t3.operation_time >= #{timeStart,jdbcType=TIMESTAMP}</if>
            <if test="timeEnd != null"><![CDATA[and t3.operation_time < #{timeEnd,jdbcType=TIMESTAMP}]]></if>
            <if test="pathNoStart != null and pathNoEnd != null">
                and (p.serial_number BETWEEN #{pathNoStart,jdbcType=VARCHAR} AND #{pathNoEnd,jdbcType=VARCHAR})
            </if>
            <if test="filter != null">and p.serial_number = #{filter,jdbcType=VARCHAR}</if>
        </where>
        <if test="order != null">order by ${order}</if>
        limit #{start,jdbcType=INTEGER}, #{size,jdbcType=INTEGER}
    </select>

    <select id="countDistributeHistory" resultType="java.lang.Long"
            parameterType="com.lifetech.dhap.pathcloud.tracking.application.condition.DistributeCondition">
        select count(p.id)
        from pathology p
        inner join block s on s.path_id = p.id
        inner join tracking t on t.block_id = s.parent_id and t.operation = 1
        inner join tracking t3 on t3.block_id = s.id and t3.operation = 9
        <where>
            <if test="departments != null">p.departments = #{departments,jdbcType=INTEGER}</if>
            <if test="operator != null">and t.operator_id = #{operator,jdbcType=BIGINT}</if>
            <if test="timeStart != null">and t3.operation_time >= #{timeStart,jdbcType=TIMESTAMP}</if>
            <if test="timeEnd != null"><![CDATA[and t3.operation_time < #{timeEnd,jdbcType=TIMESTAMP}]]></if>
            <if test="pathNoStart != null and pathNoEnd != null">
                and (p.serial_number BETWEEN #{pathNoStart,jdbcType=VARCHAR} AND #{pathNoEnd,jdbcType=VARCHAR})
            </if>
            <if test="filter != null">and p.serial_number = #{filter,jdbcType=VARCHAR}</if>
        </where>
    </select>

    <select id="countWatchedSlide" resultType="java.lang.Long" parameterType="java.util.Map">
        select count(DISTINCT block_id) from tracking where operator_id= #{userId,jdbcType=BIGINT} and operation=15
        <if test="slideIds != null and slideIds.size() > 0">
            AND block_id IN
            <foreach collection="slideIds" item="item" index="index" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
    </select>

    <select id="selectSectionOperatorByBlockId" resultType="java.lang.Long" parameterType="java.lang.Long">
        select operator_id from tracking where block_id in (select id from block where
        parent_id=#{blockId,jdbcType=BIGINT})
        ORDER BY operation_time desc limit 1
    </select>

    <select id="selectTrackingByPathId" resultMap="BaseResultMap" parameterType="java.lang.Long">
        select t.id, t.block_id, t.operation, t.operator_id,t.operator_name, t.sec_operator_id, t.operation_time,
        t.manual_flag,
        t.instrument_id, t.create_by, t.update_by, t.create_time, t.update_time, t.note,t.note_type
        from tracking t
        INNER JOIN block b on t.block_id = b.id
        LEFT JOIN block s on b.id = s.parent_id and t.block_id = s.id
        INNER join pathology p on p.id = b.path_id
        where p.id =#{pathId,jdbcType=BIGINT} and t.operation in (1,2,3,5,6,7,8,16) /*1-取材 2-取材确认 3-脱水 5-包埋 6-切片 7-染色
        8-制片确认 16-异常终止*/
    </select>

    <resultMap id="IhcTracking" type="com.lifetech.dhap.pathcloud.tracking.domain.model.BlockTracking">
        <id column="id" jdbcType="BIGINT" property="id"/>
        <result column="block_id" jdbcType="BIGINT" property="blockId"/>
        <result column="operation" jdbcType="INTEGER" property="operation"/>
        <result column="operator_id" jdbcType="BIGINT" property="operatorId"/>
        <result column="operator_name" jdbcType="VARCHAR" property="operatorName"/>
        <result column="sec_operator_id" jdbcType="BIGINT" property="secOperatorId"/>
        <result column="operation_time" jdbcType="TIMESTAMP" property="operationTime"/>
        <result column="manual_flag" jdbcType="BIT" property="manualFlag"/>
        <result column="instrument_id" jdbcType="INTEGER" property="instrumentId"/>
        <result column="create_by" jdbcType="BIGINT" property="createBy"/>
        <result column="update_by" jdbcType="BIGINT" property="updateBy"/>
        <result column="create_time" jdbcType="TIMESTAMP" property="createTime"/>
        <result column="update_time" jdbcType="TIMESTAMP" property="updateTime"/>
        <result column="note" jdbcType="LONGVARCHAR" property="note"/>
        <result column="note_type" jdbcType="VARCHAR" property="noteType"/>
        <result column="marker" jdbcType="VARCHAR" property="marker"/>
        <result column="path_id" jdbcType="BIGINT" property="pathId"/>
        <result column="block_sub_id" jdbcType="VARCHAR" property="blockSubId"/>
        <result column="slide_id" jdbcType="BIGINT" property="slideId"/>
        <result column="slide_sub_id" jdbcType="VARCHAR" property="slideSubId"/>
    </resultMap>
    <select id="selectIhcTrackingByPathId" resultMap="IhcTracking" parameterType="java.util.Map">
        select DISTINCT(t.id), ihc.path_id, ihc.block_id, ihc.sub_id as block_sub_id, s.id as slide_id, s.sub_id as slide_sub_id,
        t.operation, t.operator_id,t.operator_name, t.sec_operator_id, t.operation_time, t.manual_flag, t.instrument_id,
        t.note, t.note_type, s.marker
        from block_ihc ihc
        inner JOIN block s on ihc.block_id = s.parent_id and s.apply_id is not null
        inner join tracking t on s.id = t.block_id
        where ihc.path_id =#{pathId,jdbcType=BIGINT} and s.apply_id =  #{applyId,jdbcType=BIGINT}
        <if test="specialDye &lt;= 1">and s.special_dye = #{specialDye,jdbcType=INTEGER}</if>
        <if test="specialDye > 1">and s.special_dye > 1</if>
        and t.operation in (6,7,8,16)
    </select>

    <select id="selectBlockWaitTime" resultType="java.lang.Long"
            parameterType="com.lifetech.dhap.pathcloud.tracking.application.condition.TrackingCondition">
        select UNIX_TIMESTAMP(#{operationTime})-UNIX_TIMESTAMP(operation_time) from tracking
        where block_id = #{blockId,jdbcType=BIGINT} and operation=#{operation,jdbcType=INTEGER}
    </select>

    <select id="selectBlockWaitTimeByCondition" resultType="java.lang.Long"
            parameterType="com.lifetech.dhap.pathcloud.tracking.application.condition.TrackingCondition">
        select UNIX_TIMESTAMP(ifnull(t1.next_operation_time, now()))-UNIX_TIMESTAMP(t.operation_time)
        FROM
        (
        select operation_time, block_id
        from tracking
        where block_id = #{blockId,jdbcType=BIGINT} and operation=#{operation,jdbcType=INTEGER}
        ) t left join (
        <if test="nextOperation == 6">
            select operation_time as next_operation_time, b.parent_id as block_id
            from tracking t
            inner join block b on t.block_id = b.id and b.parent_id = #{blockId,jdbcType=BIGINT}
            where operation=#{nextOperation,jdbcType=INTEGER} or operation = 16
        </if>
        <if test="nextOperation != 6">
            select operation_time as next_operation_time, block_id
            from tracking t
            where block_id = #{blockId,jdbcType=BIGINT} and (operation=#{nextOperation,jdbcType=INTEGER} or operation =
            16)
        </if>
        order by operation_time asc limit 1
        ) t1 on t.block_id = t1.block_id
    </select>

    <select id="selectDoctorAdvice" resultType="com.lifetech.dhap.pathcloud.tracking.application.dto.DoctorAdviceDto"
            parameterType="com.lifetech.dhap.pathcloud.tracking.application.condition.DoctorAdviceCondition">
        <if test="status == 1">
            select DISTINCT t.id as id, p.id as pathId, p.status, p.serial_number as serialNumber, p.patient_name as
            patientName,
            b.id as blockId, b.sub_id as blockSubId, t.operation, t.operator_id as operatorId,t.operator_name,
            t.operation_time as operationTime,
            t.note, t.note_type as noteType, null as ihcMarker
            from tracking t
            inner join block s on s.apply_id = t.id and t.operation = 19 and t.sec_operator_id is not null
            inner join block b on s.parent_id = b.id
            inner join tracking t2 on s.id = t2.block_id and t2.operation = 8
            inner join pathology p on t.block_id = p.id
            <where>
                <if test="inspectionDoctor != null">t.operator_id = #{inspectionDoctor,jdbcType=BIGINT}</if>
                <if test="applyType != null">and t.operation = #{applyType,jdbcType=INTEGER}</if>
                <if test="filter != null">and (p.serial_number = #{filter,jdbcType=VARCHAR} OR p.patient_name LIKE
                    CONCAT(#{filter,jdbcType=VARCHAR},'%'))
                </if>
                <if test="applyTimeStart != null">AND t.operation_time >= #{applyTimeStart,jdbcType=TIMESTAMP}</if>
                <if test="applyTimeEnd != null">
                    <![CDATA[AND t.operation_time < #{applyTimeEnd,jdbcType=TIMESTAMP}]]></if>
                and p.`status` not in (25, 30, 40)
            </where>
            UNION
            select DISTINCT t.id as id, p.id as pathId, p.status, p.serial_number as serialNumber, p.patient_name as
            patientName,
            b.id as blockId, b.sub_id as blockSubId, t.operation, t.operator_id as operatorId,t.operator_name,
            t.operation_time as operationTime,
            t.note, t.note_type as noteType, null as ihcMarker
            from tracking t
            inner join block s on s.apply_id = t.id and t.operation =17 and t.sec_operator_id is not null
            inner join tracking t2 on s.id = t2.block_id and t2.operation = 8
            inner join block b on b.id = t.block_id
            inner join pathology p on b.path_id = p.id
            <where>
                <if test="inspectionDoctor != null">t.operator_id = #{inspectionDoctor,jdbcType=BIGINT}</if>
                <if test="applyType != null">and t.operation = #{applyType,jdbcType=INTEGER}</if>
                <if test="filter != null">and (p.serial_number = #{filter,jdbcType=VARCHAR} OR p.patient_name LIKE
                    CONCAT(#{filter,jdbcType=VARCHAR},'%'))
                </if>
                <if test="applyTimeStart != null">AND t.operation_time >= #{applyTimeStart,jdbcType=TIMESTAMP}</if>
                <if test="applyTimeEnd != null">
                    <![CDATA[AND t.operation_time < #{applyTimeEnd,jdbcType=TIMESTAMP}]]></if>
                and p.`status` not in (25, 30, 40)
            </where>
            UNION
            select DISTINCT t.id as id, p.id as pathId, p.status, p.serial_number as serialNumber, p.patient_name as
            patientName,
            b.id as blockId, b.sub_id as blockSubId, t.operation, t.operator_id as operatorId,t.operator_name,
            t.operation_time as operationTime,
            t.note, t.note_type as noteType, null as ihcMarker
            from tracking t
            inner join block s on s.apply_id = t.id and t.operation =30
            inner join tracking t2 on s.id = t2.block_id and t2.operation = 8
            inner join block b on b.id = t.block_id
            inner join pathology p on b.path_id = p.id
            <where>
                <if test="inspectionDoctor != null">t.operator_id = #{inspectionDoctor,jdbcType=BIGINT}</if>
                <if test="applyType != null">and t.operation = #{applyType,jdbcType=INTEGER}</if>
                <if test="filter != null">and (p.serial_number = #{filter,jdbcType=VARCHAR} OR p.patient_name LIKE
                    CONCAT(#{filter,jdbcType=VARCHAR},'%'))
                </if>
                <if test="applyTimeStart != null">AND t.operation_time >= #{applyTimeStart,jdbcType=TIMESTAMP}</if>
                <if test="applyTimeEnd != null">
                    <![CDATA[AND t.operation_time < #{applyTimeEnd,jdbcType=TIMESTAMP}]]></if>
                and p.`status` not in (25, 30, 40)
            </where>
        </if>
        <if test="status == 0">
            select p.*, p2.id as trackId from (
            select DISTINCT t.id as id, p.id as pathId, p.status, p.serial_number as serialNumber, p.patient_name as
            patientName,
            b.id as blockId, b.sub_id as blockSubId, t.operation, t.operator_id as operatorId,t.operator_name,
            t.operation_time as operationTime,
            t.note, t.note_type as noteType, null as ihcMarker
            from tracking t
            inner join pathology p on t.block_id = p.id and t.operation = 19
            left join block b on t.id = b.apply_id and b.parent_id is null
            <where>
                <if test="inspectionDoctor != null">t.operator_id = #{inspectionDoctor,jdbcType=BIGINT}</if>
                <if test="applyType != null">and t.operation = #{applyType,jdbcType=INTEGER}</if>
                <if test="filter != null">and (p.serial_number = #{filter,jdbcType=VARCHAR} OR p.patient_name LIKE
                    CONCAT(#{filter,jdbcType=VARCHAR},'%'))
                </if>
                <if test="applyTimeStart != null">AND t.operation_time >= #{applyTimeStart,jdbcType=TIMESTAMP}</if>
                <if test="applyTimeEnd != null">
                    <![CDATA[AND t.operation_time < #{applyTimeEnd,jdbcType=TIMESTAMP}]]></if>
                <![CDATA[and p.`status` <= 20]]>
            </where>
            UNION
            select DISTINCT t.id as id, p.id as pathId, p.status, p.serial_number as serialNumber, p.patient_name as
            patientName,
            b.id as blockId, b.sub_id as blockSubId, t.operation, t.operator_id as operatorId,t.operator_name,
            t.operation_time as operationTime,
            t.note, t.note_type as noteType, null as ihcMarker
            from tracking t
            inner join block b on b.id = t.block_id and t.operation =17 and t.sec_operator_id is not null
            inner join pathology p on b.path_id = p.id
            <where>
                <if test="inspectionDoctor != null">t.operator_id = #{inspectionDoctor,jdbcType=BIGINT}</if>
                <if test="applyType != null">and t.operation = #{applyType,jdbcType=INTEGER}</if>
                <if test="filter != null">and (p.serial_number = #{filter,jdbcType=VARCHAR} OR p.patient_name LIKE
                    CONCAT(#{filter,jdbcType=VARCHAR},'%'))
                </if>
                <if test="applyTimeStart != null">AND t.operation_time >= #{applyTimeStart,jdbcType=TIMESTAMP}</if>
                <if test="applyTimeEnd != null">
                    <![CDATA[AND t.operation_time < #{applyTimeEnd,jdbcType=TIMESTAMP}]]></if>
                <![CDATA[and p.`status` <= 20]]>
            </where>
            UNION
            select DISTINCT t.id as id, p.id as pathId, p.status, p.serial_number as serialNumber, p.patient_name as
            patientName,
            b.id as blockId, b.sub_id as blockSubId, t.operation, t.operator_id as operatorId,t.operator_name,
            t.operation_time as operationTime,
            t.note, t.note_type as noteType, null as ihcMarker
            from tracking t
            inner join block b on b.id = t.block_id and t.operation =30
            inner join pathology p on b.path_id = p.id
            <where>
                <if test="inspectionDoctor != null">t.operator_id = #{inspectionDoctor,jdbcType=BIGINT}</if>
                <if test="applyType != null">and t.operation = #{applyType,jdbcType=INTEGER}</if>
                <if test="filter != null">and (p.serial_number = #{filter,jdbcType=VARCHAR} OR p.patient_name LIKE
                    CONCAT(#{filter,jdbcType=VARCHAR},'%'))
                </if>
                <if test="applyTimeStart != null">AND t.operation_time >= #{applyTimeStart,jdbcType=TIMESTAMP}</if>
                <if test="applyTimeEnd != null">
                    <![CDATA[AND t.operation_time < #{applyTimeEnd,jdbcType=TIMESTAMP}]]></if>
                <![CDATA[and p.`status` <= 20]]>
            </where>
            ) p left join (
            select DISTINCT t.id as id
            from tracking t
            inner join block s on s.apply_id = t.id and t.operation = 19 and t.sec_operator_id is not null
            inner join tracking t2 on s.id = t2.block_id and t2.operation = 8
            inner join pathology p on t.block_id = p.id
            <where>
                <if test="inspectionDoctor != null">t.operator_id = #{inspectionDoctor,jdbcType=BIGINT}</if>
                <if test="applyType != null">and t.operation = #{applyType,jdbcType=INTEGER}</if>
                <if test="filter != null">and (p.serial_number = #{filter,jdbcType=VARCHAR} OR p.patient_name LIKE
                    CONCAT(#{filter,jdbcType=VARCHAR},'%'))
                </if>
                <if test="applyTimeStart != null">AND t.operation_time >= #{applyTimeStart,jdbcType=TIMESTAMP}</if>
                <if test="applyTimeEnd != null">
                    <![CDATA[AND t.operation_time < #{applyTimeEnd,jdbcType=TIMESTAMP}]]></if>
                and p.`status` not in (25, 30, 40)
            </where>
            UNION
            select DISTINCT t.id as id
            from tracking t
            inner join block s on s.apply_id = t.id and t.operation =17 and t.sec_operator_id is not null
            inner join tracking t2 on s.id = t2.block_id and t2.operation = 8
            inner join pathology p on s.path_id = p.id
            <where>
                <if test="inspectionDoctor != null">t.operator_id = #{inspectionDoctor,jdbcType=BIGINT}</if>
                <if test="applyType != null">and t.operation = #{applyType,jdbcType=INTEGER}</if>
                <if test="filter != null">and (p.serial_number = #{filter,jdbcType=VARCHAR} OR p.patient_name LIKE
                    CONCAT(#{filter,jdbcType=VARCHAR},'%'))
                </if>
                <if test="applyTimeStart != null">AND t.operation_time >= #{applyTimeStart,jdbcType=TIMESTAMP}</if>
                <if test="applyTimeEnd != null">
                    <![CDATA[AND t.operation_time < #{applyTimeEnd,jdbcType=TIMESTAMP}]]></if>
                and p.`status` not in (25, 30, 40)
            </where>
            UNION
            select DISTINCT t.id as id
            from tracking t
            inner join block s on s.apply_id = t.id and t.operation =30
            inner join tracking t2 on s.id = t2.block_id and t2.operation = 8
            inner join pathology p on s.path_id = p.id
            <where>
                <if test="inspectionDoctor != null">t.operator_id = #{inspectionDoctor,jdbcType=BIGINT}</if>
                <if test="applyType != null">and t.operation = #{applyType,jdbcType=INTEGER}</if>
                <if test="filter != null">and (p.serial_number = #{filter,jdbcType=VARCHAR} OR p.patient_name LIKE
                    CONCAT(#{filter,jdbcType=VARCHAR},'%'))
                </if>
                <if test="applyTimeStart != null">AND t.operation_time >= #{applyTimeStart,jdbcType=TIMESTAMP}</if>
                <if test="applyTimeEnd != null">
                    <![CDATA[AND t.operation_time < #{applyTimeEnd,jdbcType=TIMESTAMP}]]></if>
                and p.`status` not in (25, 30, 40)
            </where>
            ) p2 on p.id = p2.id

        </if>
        <if test="order != null">ORDER BY ${order}</if>
        limit #{start,jdbcType=INTEGER}, #{size,jdbcType=INTEGER}
    </select>

    <select id="countDoctorAdvice" resultType="java.lang.Long"
            parameterType="com.lifetech.dhap.pathcloud.tracking.application.condition.DoctorAdviceCondition">
        <if test="status == 1">
            select count(1) from (
            select DISTINCT t.id as id
            from tracking t
            inner join block s on s.apply_id = t.id and t.operation = 19 and t.sec_operator_id is not null
            inner join tracking t2 on s.id = t2.block_id and t2.operation = 8
            inner join pathology p on t.block_id = p.id
            <where>
                <if test="inspectionDoctor != null">t.operator_id = #{inspectionDoctor,jdbcType=BIGINT}</if>
                <if test="applyType != null">and t.operation = #{applyType,jdbcType=INTEGER}</if>
                <if test="filter != null">and (p.serial_number = #{filter,jdbcType=VARCHAR} OR p.patient_name LIKE
                    CONCAT(#{filter,jdbcType=VARCHAR},'%'))
                </if>
                <if test="applyTimeStart != null">AND t.operation_time >= #{applyTimeStart,jdbcType=TIMESTAMP}</if>
                <if test="applyTimeEnd != null">
                    <![CDATA[AND t.operation_time < #{applyTimeEnd,jdbcType=TIMESTAMP}]]></if>
                and p.`status` not in (25, 30, 40)
            </where>
            UNION
            select DISTINCT t.id as id
            from tracking t
            inner join block s on s.apply_id = t.id and t.operation =17 and t.sec_operator_id is not null
            inner join tracking t2 on s.id = t2.block_id and t2.operation = 8
            inner join pathology p on s.path_id = p.id
            <where>
                <if test="inspectionDoctor != null">t.operator_id = #{inspectionDoctor,jdbcType=BIGINT}</if>
                <if test="applyType != null">and t.operation = #{applyType,jdbcType=INTEGER}</if>
                <if test="filter != null">and (p.serial_number = #{filter,jdbcType=VARCHAR} OR p.patient_name LIKE
                    CONCAT(#{filter,jdbcType=VARCHAR},'%'))
                </if>
                <if test="applyTimeStart != null">AND t.operation_time >= #{applyTimeStart,jdbcType=TIMESTAMP}</if>
                <if test="applyTimeEnd != null">
                    <![CDATA[AND t.operation_time < #{applyTimeEnd,jdbcType=TIMESTAMP}]]></if>
                and p.`status` not in (25, 30, 40)
            </where>
            UNION
            select DISTINCT t.id as id
            from tracking t
            inner join block s on s.apply_id = t.id and t.operation =30
            inner join tracking t2 on s.id = t2.block_id and t2.operation = 8
            inner join pathology p on s.path_id = p.id
            <where>
                <if test="inspectionDoctor != null">t.operator_id = #{inspectionDoctor,jdbcType=BIGINT}</if>
                <if test="applyType != null">and t.operation = #{applyType,jdbcType=INTEGER}</if>
                <if test="filter != null">and (p.serial_number = #{filter,jdbcType=VARCHAR} OR p.patient_name LIKE
                    CONCAT(#{filter,jdbcType=VARCHAR},'%'))
                </if>
                <if test="applyTimeStart != null">AND t.operation_time >= #{applyTimeStart,jdbcType=TIMESTAMP}</if>
                <if test="applyTimeEnd != null">
                    <![CDATA[AND t.operation_time < #{applyTimeEnd,jdbcType=TIMESTAMP}]]></if>
                and p.`status` not in (25, 30, 40)
            </where>
            ) t
        </if>
        <if test="status == 0">
            select count(t.id) from (
            select DISTINCT t.id as id
            from tracking t
            inner join pathology p on t.block_id = p.id and t.operation = 19
            left join block b on t.id = b.apply_id and b.parent_id is null
            <where>
                <if test="inspectionDoctor != null">t.operator_id = #{inspectionDoctor,jdbcType=BIGINT}</if>
                <if test="applyType != null">and t.operation = #{applyType,jdbcType=INTEGER}</if>
                <if test="filter != null">and (p.serial_number = #{filter,jdbcType=VARCHAR} OR p.patient_name LIKE
                    CONCAT(#{filter,jdbcType=VARCHAR},'%'))
                </if>
                <if test="applyTimeStart != null">AND t.operation_time >= #{applyTimeStart,jdbcType=TIMESTAMP}</if>
                <if test="applyTimeEnd != null">
                    <![CDATA[AND t.operation_time < #{applyTimeEnd,jdbcType=TIMESTAMP}]]></if>
                <![CDATA[and p.`status` <= 20]]>
            </where>
            UNION
            select DISTINCT t.id as id
            from tracking t
            inner join block b on b.id = t.block_id and t.operation =17 and t.sec_operator_id is not null
            inner join pathology p on b.path_id = p.id
            <where>
                <if test="inspectionDoctor != null">t.operator_id = #{inspectionDoctor,jdbcType=BIGINT}</if>
                <if test="applyType != null">and t.operation = #{applyType,jdbcType=INTEGER}</if>
                <if test="filter != null">and (p.serial_number = #{filter,jdbcType=VARCHAR} OR p.patient_name LIKE
                    CONCAT(#{filter,jdbcType=VARCHAR},'%'))
                </if>
                <if test="applyTimeStart != null">AND t.operation_time >= #{applyTimeStart,jdbcType=TIMESTAMP}</if>
                <if test="applyTimeEnd != null">
                    <![CDATA[AND t.operation_time < #{applyTimeEnd,jdbcType=TIMESTAMP}]]></if>
                <![CDATA[and p.`status` <= 20]]>
            </where>
            UNION
            select DISTINCT t.id as id
            from tracking t
            inner join block b on b.id = t.block_id and t.operation =30
            inner join pathology p on b.path_id = p.id
            <where>
                <if test="inspectionDoctor != null">t.operator_id = #{inspectionDoctor,jdbcType=BIGINT}</if>
                <if test="applyType != null">and t.operation = #{applyType,jdbcType=INTEGER}</if>
                <if test="filter != null">and (p.serial_number = #{filter,jdbcType=VARCHAR} OR p.patient_name LIKE
                    CONCAT(#{filter,jdbcType=VARCHAR},'%'))
                </if>
                <if test="applyTimeStart != null">AND t.operation_time >= #{applyTimeStart,jdbcType=TIMESTAMP}</if>
                <if test="applyTimeEnd != null">
                    <![CDATA[AND t.operation_time < #{applyTimeEnd,jdbcType=TIMESTAMP}]]></if>
                <![CDATA[and p.`status` <= 20]]>
            </where>
            ) t left join (
            select DISTINCT t.id as id
            from tracking t
            inner join block s on s.apply_id = t.id and t.operation = 19 and t.sec_operator_id is not null
            inner join tracking t2 on s.id = t2.block_id and t2.operation = 8
            inner join pathology p on t.block_id = p.id
            <where>
                <if test="inspectionDoctor != null">t.operator_id = #{inspectionDoctor,jdbcType=BIGINT}</if>
                <if test="applyType != null">and t.operation = #{applyType,jdbcType=INTEGER}</if>
                <if test="filter != null">and (p.serial_number = #{filter,jdbcType=VARCHAR} OR p.patient_name LIKE
                    CONCAT(#{filter,jdbcType=VARCHAR},'%'))
                </if>
                <if test="applyTimeStart != null">AND t.operation_time >= #{applyTimeStart,jdbcType=TIMESTAMP}</if>
                <if test="applyTimeEnd != null">
                    <![CDATA[AND t.operation_time < #{applyTimeEnd,jdbcType=TIMESTAMP}]]></if>
                and p.`status` not in (25, 30, 40)
            </where>
            UNION
            select DISTINCT t.id as id
            from tracking t
            inner join block s on s.apply_id = t.id and t.operation =17 and t.sec_operator_id is not null
            inner join tracking t2 on s.id = t2.block_id and t2.operation = 8
            inner join pathology p on s.path_id = p.id
            <where>
                <if test="inspectionDoctor != null">t.operator_id = #{inspectionDoctor,jdbcType=BIGINT}</if>
                <if test="applyType != null">and t.operation = #{applyType,jdbcType=INTEGER}</if>
                <if test="filter != null">and (p.serial_number = #{filter,jdbcType=VARCHAR} OR p.patient_name LIKE
                    CONCAT(#{filter,jdbcType=VARCHAR},'%'))
                </if>
                <if test="applyTimeStart != null">AND t.operation_time >= #{applyTimeStart,jdbcType=TIMESTAMP}</if>
                <if test="applyTimeEnd != null">
                    <![CDATA[AND t.operation_time < #{applyTimeEnd,jdbcType=TIMESTAMP}]]></if>
                and p.`status` not in (25, 30, 40)
            </where>
            UNION
            select DISTINCT t.id as id
            from tracking t
            inner join block s on s.apply_id = t.id and t.operation =30
            inner join tracking t2 on s.id = t2.block_id and t2.operation = 8
            inner join pathology p on s.path_id = p.id
            <where>
                <if test="inspectionDoctor != null">t.operator_id = #{inspectionDoctor,jdbcType=BIGINT}</if>
                <if test="applyType != null">and t.operation = #{applyType,jdbcType=INTEGER}</if>
                <if test="filter != null">and (p.serial_number = #{filter,jdbcType=VARCHAR} OR p.patient_name LIKE
                    CONCAT(#{filter,jdbcType=VARCHAR},'%'))
                </if>
                <if test="applyTimeStart != null">AND t.operation_time >= #{applyTimeStart,jdbcType=TIMESTAMP}</if>
                <if test="applyTimeEnd != null">
                    <![CDATA[AND t.operation_time < #{applyTimeEnd,jdbcType=TIMESTAMP}]]></if>
                and p.`status` not in (25, 30, 40)
            </where>
            ) t2 on t.id = t2.id
        </if>
    </select>

    <select id="getDoctorAdviceLog" resultType="com.lifetech.dhap.pathcloud.tracking.application.dto.BlockTrackingDto"
            parameterType="java.lang.Long">
        select t2.operation, t2.operator_id as operatorId,t2.operator_name, u.first_name as operatorName,
        t2.operation_time as operationTime
        from block s
        inner join tracking t2 on s.id = t2.block_id
        inner join user u on t2.operator_id = u.id
        <where>
            <if test="applyId != null">s.apply_id = #{applyId,jdbcType=BIGINT}</if>
            <if test="blockId != null">and (s.id = #{blockId,jdbcType=BIGINT} or s.parent_id =
                #{blockId,jdbcType=BIGINT})
            </if>
        </where>
        <if test="blockId != null">
            union (
            select t2.operation, t2.operator_id as operatorId,t2.operator_name, u.first_name as operatorName,
            t2.operation_time as operationTime
            from tracking t2
            inner join tracking t on t.block_id = t2.block_id and t.id = #{applyId,jdbcType=BIGINT}
            inner join user u on t2.operator_id = u.id and t2.operation = 18 and t2.sec_operator_id is not null
            where t2.block_id = #{blockId,jdbcType=BIGINT} and t2.operation_time > t.operation_time order by
            t2.operation_time asc limit 1)
        </if>
        order by operationTime asc
    </select>


    <select id="InstrumentTracking"
            parameterType="com.lifetech.dhap.pathcloud.tracking.application.condition.InstrumentTrackingCon"
            resultType="com.lifetech.dhap.pathcloud.tracking.application.dto.InstrumentTrackingDto">
        SELECT i.id as instrumentId,i.`name` as instrumentName ,t.operator_name as operatorName,t.operation_time as
        operatorTime,
        i.`status` as status,i.description as description,i.type as type
        from tracking t
        INNER JOIN instrument i on t.instrument_id=i.id
        <where>
            <if test="startTime != null">AND t.operation_time >= #{startTime,jdbcType=TIMESTAMP}</if>
            <if test="endTime != null"><![CDATA[AND t.operation_time < #{endTime,jdbcType=TIMESTAMP}]]></if>
            <if test="status != null">AND i.status = #{status,jdbcType=INTEGER}</if>
            <if test="type != null">AND i.type = #{type,jdbcType=INTEGER}</if>
            <if test="operation != null">AND t.operation = #{operation,jdbcType=INTEGER}</if>
        </where>
        GROUP BY t.operation_time
        ORDER BY t.operation_time DESC
        limit #{start,jdbcType=INTEGER}, #{size,jdbcType=INTEGER}
    </select>

    <select id="InstrumentTrackingTotal"
            parameterType="com.lifetech.dhap.pathcloud.tracking.application.condition.InstrumentTrackingCon"
            resultType="java.lang.Long">

        SELECT count(1) FROM (SELECT i.id as instrumentId,i.`name` as instrumentName ,t.operator_name as
        operatorName,t.operation_time as operatorTime,
        i.`status` as status,i.description as description
        from tracking t
        INNER JOIN instrument i on t.instrument_id=i.id
        <where>
            <if test="startTime != null">AND t.operation_time >= #{startTime,jdbcType=TIMESTAMP}</if>
            <if test="endTime != null"><![CDATA[AND t.operation_time < #{endTime,jdbcType=TIMESTAMP}]]></if>
            <if test="status != null">AND i.status = #{status,jdbcType=INTEGER}</if>
            <if test="type != null">AND i.type = #{type,jdbcType=INTEGER}</if>
            <if test="operation != null">AND t.operation = #{operation,jdbcType=INTEGER}</if>
        </where>
        GROUP BY t.operation_time) a

    </select>

    <select id="countTrackingByCondition"
            parameterType="com.lifetech.dhap.pathcloud.tracking.application.condition.TrackingCondition"
            resultType="java.lang.Long">
        select count(DISTINCT (block_id)) from tracking
        <where>
            <if test="operation != null">and operation = #{operation,jdbcType=INTEGER}</if>
            <if test="operationTime != null">and operation_time >= #{operationTime,jdbcType=TIMESTAMP}</if>
        </where>
    </select>

    <select id="selectBlockIhcTrackingIdByBlockIhcId" parameterType="java.lang.Long" resultType="java.lang.Long">
        select id FROM tracking WHERE operation=30/*申请特检*/ and instrument_id=#{blockIhcId,jdbcType=BIGINT}
    </select>

    <select id="selectBlockIhcIdById" parameterType="java.lang.Long" resultType="java.lang.Long">
        select instrument_id FROM tracking WHERE operation=30/*申请特检*/ and id=#{id,jdbcType=BIGINT}
    </select>
</mapper>