<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lifetech.dhap.pathcloud.tracking.domain.BlockBorrowRepository">
  <resultMap id="BaseResultMap" type="com.lifetech.dhap.pathcloud.tracking.domain.model.BlockBorrow">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jun 08 10:39:21 CST 2017.
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="archive_id" jdbcType="BIGINT" property="archiveId" />
    <result column="borrow_name" jdbcType="VARCHAR" property="borrowName" />
    <result column="borrow_phone" jdbcType="VARCHAR" property="borrowPhone" />
    <result column="id_number" jdbcType="VARCHAR" property="idNumber" />
    <result column="cash_pledge" jdbcType="VARCHAR" property="cashPledge" />
    <result column="plan_back" jdbcType="TIMESTAMP" property="planBack" />
    <result column="real_back" jdbcType="TIMESTAMP" property="realBack" />
    <result column="borrow_type" jdbcType="INTEGER" property="borrowType" />
    <result column="tutor" jdbcType="VARCHAR" property="tutor" />
    <result column="unit" jdbcType="VARCHAR" property="unit" />
    <result column="note" jdbcType="VARCHAR" property="note" />
    <result column="departments" jdbcType="INTEGER" property="departments" />
    <result column="status" jdbcType="INTEGER" property="status" />
    <result column="archive_status" jdbcType="INTEGER" property="archiveStatus" />
    <result column="create_by" jdbcType="BIGINT" property="createBy" />
    <result column="update_by" jdbcType="BIGINT" property="updateBy" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="update_time" jdbcType="TIMESTAMP" property="updateTime" />
  </resultMap>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jun 08 10:39:21 CST 2017.
    -->
    delete from block_borrow
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="com.lifetech.dhap.pathcloud.tracking.domain.model.BlockBorrow">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jun 08 10:39:21 CST 2017.
    -->
    insert into block_borrow (archive_id, borrow_name,id_number,cash_pledge,
      borrow_phone, plan_back, real_back, 
      borrow_type, tutor, unit, 
      note, departments, status, 
      archive_status, create_by, update_by, 
      create_time, update_time)
    values (#{archiveId,jdbcType=BIGINT}, #{borrowName,jdbcType=VARCHAR}, #{idNumber,jdbcType=VARCHAR}, #{cashPledge,jdbcType=VARCHAR},
      #{borrowPhone,jdbcType=VARCHAR}, #{planBack,jdbcType=TIMESTAMP}, #{realBack,jdbcType=TIMESTAMP}, 
      #{borrowType,jdbcType=INTEGER}, #{tutor,jdbcType=VARCHAR}, #{unit,jdbcType=VARCHAR}, 
      #{note,jdbcType=VARCHAR}, #{departments,jdbcType=INTEGER}, #{status,jdbcType=INTEGER}, 
      #{archiveStatus,jdbcType=INTEGER}, #{createBy,jdbcType=BIGINT}, #{createBy,jdbcType=BIGINT},
      now(), now())
  </insert>
  <update id="updateByPrimaryKey" parameterType="com.lifetech.dhap.pathcloud.tracking.domain.model.BlockBorrow">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jun 08 10:39:21 CST 2017.
    -->
    update block_borrow
    <set>
      <if test="archiveId != null">archive_id = #{archiveId,jdbcType=BIGINT},</if>
      <if test="borrowName != null">borrow_name = #{borrowName,jdbcType=VARCHAR},</if>
      <if test="idNumber != null">id_number = #{idNumber,jdbcType=VARCHAR},</if>
      <if test="cashPledge != null">cash_pledge = #{cashPledge,jdbcType=VARCHAR},</if>
      <if test="borrowPhone != null">borrow_phone = #{borrowPhone,jdbcType=VARCHAR},</if>
      <if test="planBack != null">plan_back = #{planBack,jdbcType=TIMESTAMP},</if>
      <if test="realBack != null">real_back = #{realBack,jdbcType=TIMESTAMP},</if>
      <if test="borrowType != null">borrow_type = #{borrowType,jdbcType=INTEGER},</if>
      <if test="tutor != null">tutor = #{tutor,jdbcType=VARCHAR},</if>
      <if test="unit != null">unit = #{unit,jdbcType=VARCHAR},</if>
      <if test="note != null">note = #{note,jdbcType=VARCHAR},</if>
      <if test="departments != null">departments = #{departments,jdbcType=INTEGER},</if>
      <if test="status != null">status = #{status,jdbcType=INTEGER},</if>
      <if test="archiveStatus != null">archive_status = #{archiveStatus,jdbcType=INTEGER},</if>
      <if test="updateBy != null">update_by = #{updateBy,jdbcType=BIGINT},</if>
      update_time = now()
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jun 08 10:39:21 CST 2017.
    -->
    select id, archive_id, borrow_name, borrow_phone, plan_back, real_back, borrow_type, 
    tutor, unit, note, departments, status, archive_status, create_by, update_by, create_time, 
    update_time,id_number,cash_pledge
    from block_borrow
    where id = #{id,jdbcType=BIGINT}
  </select>
  <select id="selectAll" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jun 08 10:39:21 CST 2017.
    -->
    select id, archive_id, borrow_name, borrow_phone, plan_back, real_back, borrow_type, 
    tutor, unit, note, departments, status, archive_status, create_by, update_by, create_time, 
    update_time,id_number,cash_pledge
    from block_borrow
  </select>

  <select id="selectSlidesBorrowInfo" resultType="com.lifetech.dhap.pathcloud.tracking.application.dto.SlideArchiveInfoDto"
          parameterType="com.lifetech.dhap.pathcloud.tracking.application.condition.ArchiveCondition" >
    select b.id as borrowID, b.archive_id as blockArchiveId, a.serial_number as serialNumber, a.path_id as pathId, a.block_sub_id as blockSubId,
    a.block_id as blockId, a.slide_sub_id as slideSubId, a.slide_id as slideId, a.ihc_marker as ihcMarker, a.status,
    a.patient_name as patientName, a.archive_box as archiveBox, b.borrow_name as borrowName, b.borrow_phone as borrowPhone,
    b.unit, b.create_time as createTime, b.plan_back as planBack, TIMESTAMPDIFF(DAY, b.plan_back, now()) as overdue,
    b.archive_status as archiveStatus,b.cash_pledge as cashPledge,b.id_number as idNumber
    from block_borrow b
    inner join block_archive a on b.archive_id = a.id
    where b.status = 1 and a.serial_number = #{pathNo} and a.block_sub_id = #{blockSubId} and a.slide_sub_id = #{slideSubId}
  </select>


  <select id="selectOverdueBorrowInfo" resultType="com.lifetech.dhap.pathcloud.tracking.application.dto.SlideArchiveInfoDto">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Jun 07 12:12:19 CST 2017.
    -->
    select b.id as borrowID, b.archive_id as blockArchiveId, a.serial_number as serialNumber, a.path_id as pathId, a.block_sub_id as blockSubId,
    a.block_id as blockId, a.slide_sub_id as slideSubId, a.slide_id as slideId, a.ihc_marker as ihcMarker, a.status,
    a.patient_name as patientName, a.archive_box as archiveBox, b.borrow_name as borrowName, b.borrow_phone as borrowPhone,
    b.unit, b.create_time as createTime, b.plan_back as planBack, TIMESTAMPDIFF(DAY, b.plan_back, now()) as overdue,
    b.cash_pledge as cashPledge,b.id_number as idNumber
    from block_borrow b
    inner join block_archive a on b.archive_id = a.id
    left join system_notification n on b.id = n.receiver_id and n.source = 13
    where now() > b.plan_back and n.id is null
  </select>

  <select id="selectBlockBorrowDetail" resultType="com.lifetech.dhap.pathcloud.tracking.application.dto.SlideArchiveInfoDto">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Jun 07 12:12:19 CST 2017.
    -->
    select b.id as borrowID, b.archive_id as blockArchiveId, a.serial_number as serialNumber, a.path_id as pathId, a.block_sub_id as blockSubId,
    a.block_id as blockId, a.slide_sub_id as slideSubId, a.slide_id as slideId, a.ihc_marker as ihcMarker, a.status,
    a.patient_name as patientName, a.archive_box as archiveBox, b.borrow_name as borrowName, b.borrow_phone as borrowPhone,
    b.unit, b.create_time as createTime, b.plan_back as planBack, TIMESTAMPDIFF(SECOND, b.plan_back, now()) as overdue,
    b.cash_pledge as cashPledge,b.id_number as idNumber
    from block_borrow b
    inner join block_archive a on b.archive_id = a.id
    where b.id = #{borrowId}
  </select>

  <select id="getSlidesBrrowHistory" resultType="com.lifetech.dhap.pathcloud.tracking.application.dto.BrrowHistoryDto" parameterType="java.lang.Long">

    SELECT bb.archive_id as blockArchiveId,bb.id as borrowID ,bb.borrow_name as borrowName,bb.unit as unit,
       bb.borrow_phone as borrowPhone
      , bb.create_time as createTime,bb.plan_back as planBack, bb.real_back as realBack
    ,IFNULL(datediff(bb.real_back,bb.plan_back),datediff(NOW(),bb.plan_back)) as overdue,
    bb.id_number as idNumber,bb.cash_pledge as cashPledge
    from block_borrow bb
  WHERE bb.archive_id = #{blockArchiveId,jdbcType=BIGINT}
  </select>

</mapper>