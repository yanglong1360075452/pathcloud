<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.lifetech.dhap.pathcloud.tracking.domain.CollectMapper" >
  <resultMap id="BaseResultMap" type="com.lifetech.dhap.pathcloud.tracking.domain.model.Collect" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Sep 27 14:59:55 CST 2017.
    -->
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="target_id" property="targetId" jdbcType="BIGINT" />
    <result column="category" property="category" jdbcType="INTEGER" />
    <result column="label" property="label" jdbcType="VARCHAR" />
    <result column="permission" property="permission" jdbcType="INTEGER" />
    <result column="create_by" property="createBy" jdbcType="BIGINT" />
    <result column="update_by" property="updateBy" jdbcType="BIGINT" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="update_time" property="updateTime" jdbcType="TIMESTAMP" />
    <result column="note" property="note" jdbcType="LONGVARCHAR" />
  </resultMap>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Sep 27 14:59:55 CST 2017.
    -->
    delete from collect
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="com.lifetech.dhap.pathcloud.tracking.domain.model.Collect" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Sep 27 14:59:55 CST 2017.
    -->
    insert into collect (id, target_id, category,
    label, permission, create_by,
      update_by, create_time, update_time, 
      note)
    values (#{id,jdbcType=BIGINT}, #{targetId,jdbcType=BIGINT}, #{category,jdbcType=INTEGER}, 
      #{label,jdbcType=VARCHAR}, #{permission,jdbcType=INTEGER}, #{createBy,jdbcType=BIGINT},
      #{updateBy,jdbcType=BIGINT}, #{createTime,jdbcType=TIMESTAMP}, #{updateTime,jdbcType=TIMESTAMP}, 
      #{note,jdbcType=LONGVARCHAR})
  </insert>
  <update id="updateByPrimaryKey" parameterType="com.lifetech.dhap.pathcloud.tracking.domain.model.Collect" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Sep 27 14:59:55 CST 2017.
    -->
    update collect
    set target_id = #{targetId,jdbcType=BIGINT},
      category = #{category,jdbcType=INTEGER},
    label = #{abel,jdbcType=VARCHAR},
      permission = #{permission,jdbcType=INTEGER},
      create_by = #{createBy,jdbcType=BIGINT},
      update_by = #{updateBy,jdbcType=BIGINT},
      create_time = #{createTime,jdbcType=TIMESTAMP},
      update_time = #{updateTime,jdbcType=TIMESTAMP},
      note = #{note,jdbcType=LONGVARCHAR}
    where id = #{id,jdbcType=BIGINT}
  </update>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Sep 27 14:59:55 CST 2017.
    -->
    select id, target_id, category, label, permission, create_by, update_by, create_time,
    update_time, note
    from collect
    where id = #{id,jdbcType=BIGINT}
  </select>
  <select id="selectAll" resultMap="BaseResultMap" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Sep 27 14:59:55 CST 2017.
    -->
    select id, target_id, category, label, permission, create_by, update_by, create_time,
    update_time, note
    from collect
  </select>

  <select id="getCollects" parameterType="com.lifetech.dhap.pathcloud.tracking.application.condition.CollectCondition"
    resultType="com.lifetech.dhap.pathcloud.tracking.application.dto.CollectDetailDto">
       SELECT * FROM (SELECT c.id as collectId,p.serial_number as serialNumber,a.patient_name as patientName,
          a.sex as sex,a.age as age,c.label as label,c.permission as permission,
          c.create_time as collectDate,c.note as note,c.create_by as createBy
      from collect c
      LEFT JOIN pathology p ON c.target_id=p.id
      LEFT JOIN application a ON p.id=a.pathology_id
      WHERE c.category=1

      UNION ALL

    SELECT c.id as collectId,sa.number as serialNumber,a.patient_name as patientName,
    a.sex as sex,a.age as age,c.label as label,c.permission as permission,
    c.create_time as collectDate,c.note as note,c.create_by as createBy
    FROM collect c
    LEFT JOIN special_application sa ON sa.id=c.target_id
    LEFT JOIN pathology p ON sa.cause_id=p.id
    LEFT JOIN application a ON p.id=a.pathology_id
    where c.category=2 and sa.type != 2 and sa.type != 3

    UNION ALL

    SELECT c.id as collectId,sa.number as serialNumber,a.patient_name as patientName,
    a.sex as sex,a.age as age,c.label as label,c.permission as permission,
    c.create_time as collectDate,c.note as note,c.create_by as createBy
    FROM collect c
    LEFT JOIN special_application sa ON sa.id=c.target_id
    LEFT JOIN block b ON sa.cause_id=b.id
    LEFT JOIN pathology p ON b.path_id=p.id
    LEFT JOIN application a ON p.id=a.pathology_id
    where c.category=2 and sa.type = 2 or sa.type = 3) a
    <where>
      <if test="startTime != null">and collectDate >= #{startTime,jdbcType=TIMESTAMP}</if>
      <if test="endTime != null"><![CDATA[and collectDate <= #{endTime,jdbcType=TIMESTAMP} ]]></if>
      <if test="collect == null">and (createBy= #{createBy,jdbcType=BIGINT} or permission = 2)</if>
      <if test="collect == 1">and createBy= #{createBy,jdbcType=BIGINT}</if>
      <if test="collect == 2">and  permission = 2 AND createBy != #{createBy,jdbcType=BIGINT}</if>
      <if test="permission != null">and permission = #{permission,jdbcType=INTEGER}</if>
      <if test="label != null">and  label like CONCAT('%',#{label,jdbcType=VARCHAR},'%')</if>
      <if test="filter != null">and (patientName LIKE CONCAT(#{filter,jdbcType=VARCHAR},'%') OR serialNumber = #{filter,jdbcType=VARCHAR})</if>
    </where>
    ORDER BY collectDate DESC
    limit #{start,jdbcType=INTEGER}, #{size,jdbcType=INTEGER}

  </select>

  <select id="getCollectsTotal" parameterType="com.lifetech.dhap.pathcloud.tracking.application.condition.CollectCondition"
          resultType="java.lang.Long">
    SELECT count(1) FROM (SELECT * FROM (SELECT c.id as collectId,p.serial_number as serialNumber,a.patient_name as
    patientName,
    a.sex as sex,a.age as age,c.label as label,c.permission as permission,
    c.create_time as collectDate,c.note as note,c.create_by as createBy
    from collect c
    LEFT JOIN pathology p ON c.target_id=p.id
    LEFT JOIN application a ON p.id=a.pathology_id
    WHERE c.category=1

    UNION ALL

    SELECT c.id as collectId,sa.number as serialNumber,a.patient_name as patientName,
    a.sex as sex,a.age as age,c.label as label,c.permission as permission,
    c.create_time as collectDate,c.note as note,c.create_by as createBy
    FROM collect c
    LEFT JOIN special_application sa ON sa.id=c.target_id
    LEFT JOIN pathology p ON sa.cause_id=p.id
    LEFT JOIN application a ON p.id=a.pathology_id
    where c.category=2 and sa.type != 2 and sa.type != 3


    UNION ALL

    SELECT c.id as collectId,sa.number as serialNumber,a.patient_name as patientName,
    a.sex as sex,a.age as age,c.label as label,c.permission as permission,
    c.create_time as collectDate,c.note as note,c.create_by as createBy
    FROM collect c
    LEFT JOIN special_application sa ON sa.id=c.target_id
    LEFT JOIN block b ON sa.cause_id=b.id
    LEFT JOIN pathology p ON b.path_id=p.id
    LEFT JOIN application a ON p.id=a.pathology_id
    where c.category=2 and sa.type = 2 or sa.type = 3) a
    <where>
      <if test="startTime != null">and collectDate >= #{startTime,jdbcType=TIMESTAMP}</if>
      <if test="endTime != null"><![CDATA[and collectDate <= #{endTime,jdbcType=TIMESTAMP} ]]></if>
      <if test="collect == null">and (createBy= #{createBy,jdbcType=BIGINT} or permission = 2)</if>
      <if test="collect == 1">and createBy= #{createBy,jdbcType=BIGINT}</if>
      <if test="collect == 2">and  permission = 2 AND createBy != #{createBy,jdbcType=BIGINT}</if>
      <if test="permission != null">and permission = #{permission,jdbcType=INTEGER}</if>
      <if test="label != null">and  label like CONCAT('%',#{label,jdbcType=VARCHAR},'%')</if>
      <if test="filter != null">and (patientName LIKE CONCAT(#{filter,jdbcType=VARCHAR},'%') OR serialNumber = #{filter,jdbcType=VARCHAR})</if>
    </where>) a

  </select>

  <select id="selectCollectByCondition" parameterType="com.lifetech.dhap.pathcloud.tracking.application.condition.CollectCondition" resultMap="BaseResultMap">
    select * from collect
    where target_id = #{targetId,jdbcType=BIGINT} and category = #{category,jdbcType=INTEGER} and create_by =#{createBy,jdbcType=BIGINT}
  </select>

  <select id="getCollectByIdAndCreateBy" parameterType="map" resultMap="BaseResultMap">
        select * from collect
    where create_by=#{createById,jdbcType=BIGINT} AND id = #{id,jdbcType=BIGINT}
  </select>
</mapper>