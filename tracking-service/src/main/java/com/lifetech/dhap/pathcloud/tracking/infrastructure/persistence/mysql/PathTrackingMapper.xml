<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.lifetech.dhap.pathcloud.tracking.domain.PathTrackingRepository" >
  <resultMap id="BaseResultMap" type="com.lifetech.dhap.pathcloud.tracking.domain.model.PathTracking" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jan 16 12:57:50 CST 2017.
    -->
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="path_id" property="pathId" jdbcType="BIGINT" />
    <result column="operation" property="operation" jdbcType="INTEGER" />
    <result column="operator_id" property="operatorId" jdbcType="BIGINT" />
    <result column="sec_operator_id" property="secOperatorId" jdbcType="BIGINT" />
    <result column="operation_time" property="operationTime" jdbcType="TIMESTAMP" />
    <result column="note_type" property="noteType" jdbcType="VARCHAR" />
    <result column="create_by" property="createBy" jdbcType="BIGINT" />
    <result column="update_by" property="updateBy" jdbcType="BIGINT" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="update_time" property="updateTime" jdbcType="TIMESTAMP" />
    <result column="note" property="note" jdbcType="LONGVARCHAR" />
  </resultMap>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jan 16 12:57:50 CST 2017.
    -->
    delete from path_tracking
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="com.lifetech.dhap.pathcloud.tracking.domain.model.PathTracking" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jan 16 12:57:50 CST 2017.
    -->
    insert into path_tracking (id, path_id, operation, 
      operator_id, sec_operator_id, operation_time, 
      note_type, create_by, update_by, 
      create_time, update_time, note
      )
    values (#{id,jdbcType=BIGINT}, #{pathId,jdbcType=BIGINT}, #{operation,jdbcType=INTEGER}, 
      #{operatorId,jdbcType=BIGINT}, #{secOperatorId,jdbcType=BIGINT}, now(),
      #{noteType,jdbcType=VARCHAR}, #{createBy,jdbcType=BIGINT}, #{createBy,jdbcType=BIGINT},
      now(), now(), #{note,jdbcType=LONGVARCHAR}
      )
  </insert>
  <update id="updateByPrimaryKey" parameterType="com.lifetech.dhap.pathcloud.tracking.domain.model.PathTracking" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jan 16 12:57:50 CST 2017.
    -->
    update path_tracking
    set path_id = #{pathId,jdbcType=BIGINT},
      operation = #{operation,jdbcType=INTEGER},
      operator_id = #{operatorId,jdbcType=BIGINT},
      sec_operator_id = #{secOperatorId,jdbcType=BIGINT},
      operation_time = #{operationTime,jdbcType=TIMESTAMP},
      note_type = #{noteType,jdbcType=VARCHAR},
      update_by = #{updateBy,jdbcType=BIGINT},
      update_time = now(),
      note = #{note,jdbcType=LONGVARCHAR}
    where id = #{id,jdbcType=BIGINT}
  </update>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jan 16 12:57:50 CST 2017.
    -->
    select id, path_id, operation, operator_id, sec_operator_id, operation_time, note_type, 
    create_by, update_by, create_time, update_time, note
    from path_tracking
    where id = #{id,jdbcType=BIGINT}
  </select>
  <select id="selectAll" resultMap="BaseResultMap" >
    select id, path_id, operation, operator_id, sec_operator_id, operation_time, note_type, 
    create_by, update_by, create_time, update_time, note
    from path_tracking
  </select>

  <select id="last" resultType="java.lang.Long" useCache="false">
    SELECT LAST_INSERT_ID()
  </select>

  <select id="selectByCondition" parameterType="com.lifetech.dhap.pathcloud.tracking.application.condition.PathTrackingCondition" resultMap="BaseResultMap">
    select id, path_id, operation, operator_id, sec_operator_id, operation_time, note_type,
    create_by, update_by, create_time, update_time, note
    from path_tracking
    where path_id = #{pathId,jdbcType=BIGINT}
    <if test="operations != null">
      and operation in
      <foreach collection="operations" item="item" index="index" open="(" separator="," close=")">
        #{item}
      </foreach>
    </if>
  </select>

  <select id="reportQuery" parameterType="com.lifetech.dhap.pathcloud.tracking.application.condition.ReportCondition"
   resultType="com.lifetech.dhap.pathcloud.tracking.application.dto.ReportQueryDto">
    SELECT * FROM (
    select t.*,IF(DATEDIFF(reportTime,create_time)>GREATEST(typeDay,difficultDay,decalcifyDay),TRUE ,FALSE) as delay FROM  (
    SELECT p.id as id,NULL as specialApplyId,p.serial_number as serialNumber,a.patient_name as name,a.departments as departments,
    a.doctor as doctor ,pt.operator_id as diagnoseDoctor,pt.operation_time as reportTime,
    if(ptt.id is null,false,TRUE) as printStatus,ptt.operation_time as printTime,
    ptt.operator_id as printUserId,p.create_time,ptt.operation,p.status,
    if(b.biaoshi is not null,#{decalcifyDeadline,jdbcType=INTEGER},0) as decalcifyDay,if(p.label=1,#{difficultDeadline,jdbcType=INTEGER},0) as difficultDay, #{reportDeadline,jdbcType=INTEGER} as typeDay
    FROM pathology p
    INNER JOIN application a ON p.id=a.pathology_id
    INNER JOIN path_tracking pt ON pt.path_id=p.id AND pt.operation=13
    LEFT JOIN path_tracking ptt ON ptt.path_id=p.id AND ptt.operation=23
    LEFT JOIN block b on b.path_id = p.id and b.biaoshi=3 /*脱钙*/
    UNION ALL
    select p.id,sa.id as specialApplyId,sa.number as serialNumber,p.patient_name as name,p.departments as departments,
    a.doctor as doctor,sa.update_by as diagnoseDoctor,sa.update_time as reportTime,
    if(pt.id is null,false,TRUE) as printStatus,pt.operation_time as printTime,
    pt.operation_time as printUserId,sa.create_time,null as operation,sa.status,
    if(b.biaoshi is not null,#{decalcifyDeadline,jdbcType=INTEGER},0) as decalcifyDay,if(p.label=1,#{difficultDeadline,jdbcType=INTEGER},0) as difficultDay,
    if(sa.type =1,#{freezeReportDeadline,jdbcType=INTEGER},if(sa.type=2,#{ihcReportDeadline,jdbcType=INTEGER},if(sa.type=3,#{specialDyeReportDeadline,jdbcType=INTEGER},#{consultReportDeadline,jdbcType=INTEGER}))) as typeDay
    FROM special_application sa
    INNER JOIN pathology p on sa.path_no = p.serial_number
    INNER JOIN application a on p.id=a.pathology_id
    LEFT JOIN path_tracking pt ON pt.sec_operator_id=sa.id AND pt.operation=23
    LEFT JOIN block b on b.path_id = p.id and b.biaoshi=3 /*脱钙*/
    ) as t) as tt
        <where>
          status = 25
          <if test="filter != null"> AND serialNumber = #{filter,jdbcType=VARCHAR}</if>
          <if test="startTime != null">AND reportTime >= #{startTime,jdbcType=TIMESTAMP}</if>
          <if test="endTime != null"><![CDATA[and reportTime <= #{endTime,jdbcType=TIMESTAMP} ]]></if>
          <if test="departments != null">AND departments = #{departments,jdbcType=INTEGER}</if>
          <if test=" printStatus != null">AND printStatus = #{printStatus,jdbcType=BIT}</if>
          <if test="delay != null">AND delay = #{delay,jdbcType=BIT}</if>
        </where>
        GROUP BY serialNumber
        <if test="order != null">ORDER BY ${order}</if>
    limit #{start,jdbcType=INTEGER}, #{size,jdbcType=INTEGER}
  </select>

  <select id="reportQueryTotal" parameterType="com.lifetech.dhap.pathcloud.tracking.application.condition.ReportCondition"
   resultType="java.lang.Long">
    SELECT count(DISTINCT serialNumber ) from (
    select * from (
    select t.*,IF(DATEDIFF(reportTime,create_time)>GREATEST(typeDay,difficultDay,decalcifyDay),TRUE ,FALSE) as delay FROM  (
    SELECT p.id as id,NULL as specialApplyId,p.serial_number as serialNumber,a.patient_name as name,a.departments as departments,
    a.doctor as doctor ,pt.operator_id as diagnoseDoctor,pt.operation_time as reportTime,
    if(ptt.id is null,false,TRUE) as printStatus,ptt.operation_time as printTime,
    ptt.operator_id as printUserId,p.create_time,ptt.operation,p.status,
    if(b.biaoshi is not null,#{decalcifyDeadline,jdbcType=INTEGER},0) as decalcifyDay,if(p.label=1,#{difficultDeadline,jdbcType=INTEGER},0) as difficultDay, #{reportDeadline,jdbcType=INTEGER} as typeDay
    FROM pathology p
    INNER JOIN application a ON p.id=a.pathology_id
    INNER JOIN path_tracking pt ON pt.path_id=p.id AND pt.operation=13
    LEFT JOIN path_tracking ptt ON ptt.path_id=p.id AND ptt.operation=23
    LEFT JOIN block b on b.path_id = p.id and b.biaoshi=3 /*脱钙*/
    UNION ALL
    select p.id,sa.id as specialApplyId,sa.number as serialNumber,p.patient_name as name,p.departments as departments,
    a.doctor as doctor,sa.update_by as diagnoseDoctor,sa.update_time as reportTime,
    if(pt.id is null,false,TRUE) as printStatus,pt.operation_time as printTime,
    pt.operation_time as printUserId,sa.create_time,null as operation,sa.status,
    if(b.biaoshi is not null,#{decalcifyDeadline,jdbcType=INTEGER},0) as decalcifyDay,if(p.label=1,#{difficultDeadline,jdbcType=INTEGER},0) as difficultDay,
    if(sa.type =1,#{freezeReportDeadline,jdbcType=INTEGER},if(sa.type=2,#{ihcReportDeadline,jdbcType=INTEGER},if(sa.type=3,#{specialDyeReportDeadline,jdbcType=INTEGER},#{consultReportDeadline,jdbcType=INTEGER}))) as typeDay
    FROM special_application sa
    INNER JOIN pathology p on sa.path_no = p.serial_number
    INNER JOIN application a on p.id=a.pathology_id
    LEFT JOIN path_tracking pt ON pt.sec_operator_id=sa.id AND pt.operation=23
    LEFT JOIN block b on b.path_id = p.id and b.biaoshi=3 /*脱钙*/
    ) as t) as tt) as ttt
    <where>
      status = 25
      <if test="filter != null"> AND serialNumber = #{filter,jdbcType=VARCHAR}</if>
      <if test="startTime != null">AND reportTime >= #{startTime,jdbcType=TIMESTAMP}</if>
      <if test="endTime != null"><![CDATA[and reportTime <= #{endTime,jdbcType=TIMESTAMP} ]]></if>
      <if test="departments != null">AND departments = #{departments,jdbcType=INTEGER}</if>
      <if test=" printStatus != null">AND printStatus = #{printStatus,jdbcType=BIT}</if>
      <if test="delay != null">AND delay = #{delay,jdbcType=BIT}</if>
    </where>
  </select>

  <select id="signQuery" parameterType="com.lifetech.dhap.pathcloud.tracking.application.condition.ReportCondition"
          resultType="com.lifetech.dhap.pathcloud.tracking.application.dto.SignQueryDto">
    select * from (
    SELECT t.*, IF(DATEDIFF(reportTime,create_time)>GREATEST(difficultDay,typeDay,decalcifyDay),TRUE ,FALSE) as delay FROM (
    select p.id as pathId,null as specialApplyId,p.serial_number as serialNumber,a.patient_name as name,
    a.departments,ptt.operation_time,a.doctor ,pt.operator_id as diagnoseDoctor,pt.operation_time as reportTime,
    ptt.operation as operation,p.create_time,
    if(b.biaoshi is not null,#{decalcifyDeadline,jdbcType=INTEGER},0) as decalcifyDay,if(p.label=1,#{difficultDeadline,jdbcType=INTEGER},0) as difficultDay,  #{reportDeadline,jdbcType=INTEGER}  as typeDay
    from pathology p
    INNER JOIN application a ON p.id=a.pathology_id <if test="departments != null">AND a.departments = #{departments,jdbcType=INTEGER}</if>
    LEFT JOIN block b on b.path_id = p.id and b.biaoshi=3 /*脱钙*/
    INNER JOIN path_tracking pt ON pt.path_id=p.id AND pt.operation=13
    INNER JOIN path_tracking ptt on p.id = ptt.path_id and  ptt.sec_operator_id is NULL and ptt.operation = #{operation,jdbcType=INTEGER} <if test="startTime != null">AND ptt.operation_time >= #{startTime,jdbcType=TIMESTAMP}</if>
    /*查询是否有签收确认的记录,以此确定当前状态*/
    where  IFNULL(ptt.id = (select id from path_tracking where path_id=ptt.path_id and operation=26 and sec_operator_id is NULL ORDER BY operation_time desc limit 1),
    ptt.id=(select id from path_tracking where path_id=ptt.path_id and operation=25 and sec_operator_id is NULL order by operation_time DESC limit 1))
    /*控制一个病理多条申请取第一条*/
    AND  a.id = (select id from application WHERE pathology_id=a.pathology_id order by create_time limit 1)
    <if test="filter != null"> AND p.serial_number = #{filter,jdbcType=VARCHAR}</if>
    UNION ALL
    select p.id as pathId,sa.id as specialApplyId,sa.number as serialNumber,a.patient_name as name,
    a.departments,ptt.operation_time,a.doctor ,sa.update_by as diagnoseDoctor,sa.update_time as reportTime,
    ptt.operation as operation,sa.create_time,
    if(b.biaoshi is not null,#{decalcifyDeadline,jdbcType=INTEGER},0) as decalcifyDay,if(p.label=1,#{difficultDeadline,jdbcType=INTEGER},0) as difficultDay,
    if(sa.type =1,#{freezeReportDeadline,jdbcType=INTEGER},if(sa.type=2,#{ihcReportDeadline,jdbcType=INTEGER},if(sa.type=3,#{specialDyeReportDeadline,jdbcType=INTEGER},#{consultReportDeadline,jdbcType=INTEGER}))) as typeDay
    from special_application sa
    INNER JOIN pathology p on p.serial_number = sa.path_no
    LEFT JOIN block b on b.path_id = p.id and b.biaoshi=3 /*脱钙*/
    INNER JOIN application a ON p.id=a.pathology_id <if test="departments != null">AND a.departments = #{departments,jdbcType=INTEGER}</if>
    INNER JOIN path_tracking ptt on p.id = ptt.path_id and  ptt.sec_operator_id is NOT NULL and ptt.operation = #{operation,jdbcType=INTEGER} <if test="startTime != null">AND ptt.operation_time >= #{startTime,jdbcType=TIMESTAMP}</if>
    where  IFNULL(ptt.id = (select id from path_tracking where path_id=ptt.path_id and operation=26 and sec_operator_id is NOT NULL ORDER BY operation_time desc limit 1),
    ptt.id=(select id from path_tracking where path_id=ptt.path_id and operation=25 and sec_operator_id is NOT NULL order by operation_time DESC limit 1))
    AND  a.id = (select id from application WHERE pathology_id=a.pathology_id order by create_time limit 1)
    <if test="filter != null"> AND sa.number = #{filter,jdbcType=VARCHAR}</if>
    ) as t) as tt
    <where>
      <if test="delay != null">AND delay = #{delay,jdbcType=BIT}</if>
    </where>
    GROUP BY serialNumber
    <if test="order != null">ORDER BY ${order}</if>
    limit #{start,jdbcType=INTEGER}, #{size,jdbcType=INTEGER}
  </select>

  <select id="signQueryTotal" parameterType="com.lifetech.dhap.pathcloud.tracking.application.condition.ReportCondition"
          resultType="java.lang.Long">
    select count(DISTINCT serialNumber) from (
    SELECT t.*, IF(DATEDIFF(reportTime,create_time)>GREATEST(difficultDay,typeDay,decalcifyDay),TRUE ,FALSE) as delay FROM (
    select p.id as pathId,null as specialApplyId,p.serial_number as serialNumber,a.patient_name as name,
    a.departments,ptt.operation_time,a.doctor ,pt.operator_id as diagnoseDoctor,pt.operation_time as reportTime,
    ptt.operation as operation,p.create_time,
    if(b.biaoshi is not null,#{decalcifyDeadline,jdbcType=INTEGER},0) as decalcifyDay,if(p.label=1,#{difficultDeadline,jdbcType=INTEGER},0) as difficultDay,  #{reportDeadline,jdbcType=INTEGER}  as typeDay
    from pathology p
    INNER JOIN application a ON p.id=a.pathology_id <if test="departments != null">AND a.departments = #{departments,jdbcType=INTEGER}</if>
    LEFT JOIN block b on b.path_id = p.id and b.biaoshi=3 /*脱钙*/
    INNER JOIN path_tracking pt ON pt.path_id=p.id AND pt.operation=13
    INNER JOIN path_tracking ptt on p.id = ptt.path_id and  ptt.sec_operator_id is NULL and ptt.operation = #{operation,jdbcType=INTEGER} <if test="startTime != null">AND ptt.operation_time >= #{startTime,jdbcType=TIMESTAMP}</if>
    /*查询是否有签收确认的记录,以此确定当前状态*/
    where  IFNULL(ptt.id = (select id from path_tracking where path_id=ptt.path_id and operation=26 and sec_operator_id is NULL ORDER BY operation_time desc limit 1),
    ptt.id=(select id from path_tracking where path_id=ptt.path_id and operation=25 and sec_operator_id is NULL order by operation_time DESC limit 1))
    /*控制一个病理多条申请取第一条*/
    AND  a.id = (select id from application WHERE pathology_id=a.pathology_id order by create_time limit 1)
    <if test="filter != null"> AND p.serial_number = #{filter,jdbcType=VARCHAR}</if>
    UNION ALL
    select p.id as pathId,sa.id as specialApplyId,sa.number as serialNumber,a.patient_name as name,
    a.departments,ptt.operation_time,a.doctor ,sa.update_by as diagnoseDoctor,sa.update_time as reportTime,
    ptt.operation as operation,sa.create_time,
    if(b.biaoshi is not null,#{decalcifyDeadline,jdbcType=INTEGER},0) as decalcifyDay,if(p.label=1,#{difficultDeadline,jdbcType=INTEGER},0) as difficultDay,
    if(sa.type =1,#{freezeReportDeadline,jdbcType=INTEGER},if(sa.type=2,#{ihcReportDeadline,jdbcType=INTEGER},if(sa.type=3,#{specialDyeReportDeadline,jdbcType=INTEGER},#{consultReportDeadline,jdbcType=INTEGER}))) as typeDay
    from special_application sa
    INNER JOIN pathology p on p.serial_number = sa.path_no
    LEFT JOIN block b on b.path_id = p.id and b.biaoshi=3 /*脱钙*/
    INNER JOIN application a ON p.id=a.pathology_id <if test="departments != null">AND a.departments = #{departments,jdbcType=INTEGER}</if>
    INNER JOIN path_tracking ptt on p.id = ptt.path_id and  ptt.sec_operator_id is NOT NULL and ptt.operation = #{operation,jdbcType=INTEGER} <if test="startTime != null">AND ptt.operation_time >= #{startTime,jdbcType=TIMESTAMP}</if>
    where  IFNULL(ptt.id = (select id from path_tracking where path_id=ptt.path_id and operation=26 and sec_operator_id is NOT NULL ORDER BY operation_time desc limit 1),
    ptt.id=(select id from path_tracking where path_id=ptt.path_id and operation=25 and sec_operator_id is NOT NULL order by operation_time DESC limit 1))
    AND  a.id = (select id from application WHERE pathology_id=a.pathology_id order by create_time limit 1)
    <if test="filter != null"> AND sa.number = #{filter,jdbcType=VARCHAR}</if>
    ) as t) as tt
    <where>
      <if test="delay != null">AND delay = #{delay,jdbcType=BIT}</if>
    </where>
  </select>

  <select id="printRecordQuery"  parameterType="java.lang.Long"
          resultType="com.lifetech.dhap.pathcloud.tracking.application.dto.ReportQueryDto">
    SELECT p.id as id,p.serial_number as serialNumber,ptt.operation_time as printTime,ptt.operator_id as printUserId
    FROM pathology p
    INNER JOIN path_tracking pt ON pt.path_id=p.id AND pt.operation=13
    LEFT JOIN path_tracking ptt ON ptt.path_id=p.id AND ptt.operation=23
    WHERE p.id = #{id,jdbcType=BIGINT}
  </select>

  <select id="specialPrintRecordQuery" parameterType="java.lang.Long"
          resultType="com.lifetech.dhap.pathcloud.tracking.application.dto.ReportQueryDto">
    SELECT sa.id as specialApplyId,sa.number as serialNumber,pt.operation_time as printTime,pt.operator_id as printUserId FROM special_application sa
    INNER JOIN path_tracking pt on sa.id = pt.sec_operator_id and pt.operation=23
    WHERE sa.id = #{id,jdbcType=BIGINT}
  </select>

  <select id="getPathTrackingByPathId" parameterType="java.lang.Long" resultMap="BaseResultMap">
    select id, path_id, operation, operator_id, sec_operator_id, operation_time, note_type,
    create_by, update_by, create_time, update_time, note
    from path_tracking
    where path_id = #{id,jdbcType=BIGINT} AND operation = 33
  </select>

  <select id="getPathTrackingByPathIdAndPrintSign" resultMap="BaseResultMap" parameterType="map">
        select id, path_id, operation, operator_id, sec_operator_id, operation_time, note_type,
    create_by, update_by, create_time, update_time, note
    from path_tracking
    where path_id = #{pathId,jdbcType=BIGINT} AND operation = #{printSign,jdbcType=BIGINT}
  </select>

</mapper>